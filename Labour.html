<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Construction Labor Management System</title>
    <style>
        /* Existing CSS styles here */
        body { 
            font-family: Arial, sans-serif; 
            padding: 20px; 
            max-width: 1200px; 
            margin: 0 auto;
            background-color: #f5f5f5;
        }

        /* Updated styles for the top navigation */
        .top-nav {
            display: flex;
            justify-content: flex-start;
            margin-bottom: 10px;
        }

        .home-btn {
            display: flex;
            align-items: center;
            padding: 8px 16px;
            color: #2196F3;
            background-color: transparent;
            text-decoration: none;
            border-radius: 4px;
            font-size: 24px;
            transition: background-color 0.2s;
        }

        .home-btn:hover {
            background-color: #e0e0e0;
        }

        .home-btn span {
            font-size: 24px;
        }

        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .section-header {
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Buttons */
        button { 
            padding: 8px 16px; 
            color: white; 
            border: none; 
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }

        .primary-btn {
            background-color: #4CAF50;
        }

        .primary-btn:hover {
            background-color: #45a049;
        }

        .edit-btn {
            background-color: #2196F3;
            padding: 4px 12px;
        }

        .edit-btn:hover {
            background-color: #1976D2;
        }

        .delete-btn {
            background-color: #f44336;
            padding: 4px 12px;
        }

        .delete-btn:hover {
            background-color: #d32f2f;
        }

        .add-btn {
            background-color: #ff9800;
            padding: 8px 16px;
        }

        .add-btn:hover {
            background-color: #f57c00;
        }

        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
            background: white;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }

        th {
            background-color: #f5f5f5;
            font-weight: bold;
        }

        tr:hover {
            background-color: #f9f9f9;
        }

        /* Status Classes */
        .present { 
            background-color: #e8f5e9; 
        }

        .present:hover { 
            background-color: #c8e6c9; 
        }

        .absent { 
            background-color: #ffebee; 
        }

        .absent:hover { 
            background-color: #ffcdd2; 
        }

        /* Form Controls */
        .controls-group {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .control-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        select, input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            min-width: 200px;
        }

        select:disabled {
            background-color: #f5f5f5;
            cursor: not-allowed;
        }

        /* Assignment Section */
        .assignment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .timestamp {
            color: #666;
            font-size: 0.9em;
        }

        /* Reports Section */
        .reports-container {
            margin-top: 20px;
            padding: 15px;
            border-top: 1px solid #ddd;
        }

        .total-row {
            font-weight: bold;
            background-color: #f5f5f5;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .controls-group {
                flex-direction: column;
                align-items: stretch;
            }

            select, input {
                width: 100%;
                min-width: unset;
            }

            table {
                display: block;
                overflow-x: auto;
            }

            /* Adjust top navigation for mobile */
            .top-nav {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <!-- Top Navigation with Home Icon -->
    <div class="top-nav">
        <a href="index.html" class="home-btn" aria-label="Home">
            <span>üè†</span>
        </a>
    </div>

    <h1>Construction Labor Management System</h1>

    <!-- Setup Section -->
    <div class="container">
        <div class="section-header">
            <h2>Initial Setup</h2>
            <div>
                <button class="primary-btn" onclick="addSite()">Add Site</button>
                <button class="primary-btn" onclick="addWorker()">Add Worker</button>
                <button class="primary-btn" onclick="addSubContractor()">Add Sub Contractor</button>
            </div>
        </div>

        <!-- Sites Table -->
        <h3>Construction Sites</h3>
        <table>
            <thead>
                <tr>
                    <th>Site Name</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="sitesList"></tbody>
        </table>

        <!-- Workers Table -->
        <h3>Workers</h3>
        <table>
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Type</th>
                    <th>Contact</th>
                    <th>Daily Wage</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="workersList"></tbody>
        </table>

        <!-- Sub Contractors Table -->
        <h3>Sub Contractors</h3>
        <table>
            <thead>
                <tr>
                    <th>Type of Work</th>
                    <th>Name</th>
                    <th>Number of Workers</th>
                    <th>Daily Rate</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="subContractorsList"></tbody>
        </table>
    </div>

    <!-- Daily Assignment Section -->
    <div class="container">
        <div class="section-header">
            <h2>Daily Labor Assignment</h2>
        </div>

        <div class="controls-group">
            <div class="control-item">
                <label>1. Select Date:</label>
                <input type="date" id="currentDate" onchange="handleDateChange()">
            </div>
            <div class="control-item">
                <label>2. Select Site:</label>
                <select id="siteSelect" onchange="handleSiteChange()" disabled>
                    <option value="">Choose a site...</option>
                </select>
            </div>
            <div class="control-item">
                <label>3. Select Worker:</label>
                <select id="workerSelect" disabled>
                    <option value="">Choose a worker...</option>
                </select>
            </div>
            <button id="addWorkerBtn" class="add-btn" onclick="assignSelectedWorker()" disabled>
                Add Worker
            </button>
            <div class="control-item">
                <label>4. Select Sub Contractor:</label>
                <select id="subContractorSelect" disabled>
                    <option value="">Choose a sub contractor...</option>
                </select>
            </div>
            <button id="addSubContractorBtn" class="add-btn" onclick="assignSelectedSubContractor()" disabled>
                Add Sub Contractor
            </button>
        </div>

        <div id="currentAssignments"></div>
    </div>

    <!-- Reports Section -->
    <div class="container">
        <div class="section-header">
            <h2>Reports</h2>
        </div>

        <div class="controls-group">
            <div class="control-item">
                <label>Select Week:</label>
                <input type="week" id="weekSelect">
            </div>
            <button class="primary-btn" onclick="showDailyReport()">Daily Report</button>
            <button class="primary-btn" onclick="showWeeklyReport()">Weekly Report</button>
        </div>

        <div id="reportArea"></div>
    </div>

    <!-- JavaScript Code -->
    <script>
        // Data Storage
        var sites = [];
        var workers = [];
        var subContractors = [];
        var assignments = {};

        // Initialize the page
        function initializePage() {
            document.getElementById('currentDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('weekSelect').value = getCurrentWeek();
            updateSitesList();
            updateWorkersList();
            updateSubContractorsList();
        }

        // Call initializePage when the window loads
        window.onload = initializePage;

        // Helper Functions
        function getCurrentWeek() {
            var now = new Date();
            var onejan = new Date(now.getFullYear(), 0, 1);
            var week = Math.ceil((((now - onejan) / 86400000) + onejan.getDay() + 1) / 7);
            return now.getFullYear() + '-W' + week.toString().padStart(2, '0');
        }

        function formatCurrency(amount) {
            return 'R' + parseFloat(amount).toFixed(2);
        }

        // Site Management
        function addSite() {
            var name = prompt("Enter site name:");
            if (name && name.trim()) {
                sites.push({
                    id: Date.now(),
                    name: name.trim()
                });
                updateSitesList();
                updateSiteSelect();
            }
        }

        function editSite(siteId) {
            var site = sites.find(function(s) { return s.id === siteId; });
            if (!site) return;

            var newName = prompt("Edit site name:", site.name);
            if (newName && newName.trim() && newName !== site.name) {
                site.name = newName.trim();
                updateSitesList();
                updateSiteSelect();
            }
        }

        function deleteSite(siteId) {
            if (!confirm("Are you sure you want to delete this site?")) return;
            
            // Remove site and its assignments
            sites = sites.filter(function(s) { return s.id !== siteId; });
            Object.keys(assignments).forEach(function(date) {
                // Workers
                if (assignments[date]['workers']) {
                    Object.keys(assignments[date]['workers']).forEach(function(workerId) {
                        if (assignments[date]['workers'][workerId].siteId === siteId) {
                            delete assignments[date]['workers'][workerId];
                        }
                    });
                }
                // Sub Contractors
                if (assignments[date]['subContractors']) {
                    Object.keys(assignments[date]['subContractors']).forEach(function(scId) {
                        if (assignments[date]['subContractors'][scId].siteId === siteId) {
                            delete assignments[date]['subContractors'][scId];
                        }
                    });
                }
            });

            updateSitesList();
            updateSiteSelect();
            updateCurrentAssignments();
        }

        function updateSitesList() {
            var tbody = document.getElementById('sitesList');
            tbody.innerHTML = sites.map(function(site) {
                return '<tr>' +
                    '<td>' + site.name + '</td>' +
                    '<td>' +
                        '<button class="edit-btn" onclick="editSite(' + site.id + ')">Edit</button>' +
                        '<button class="delete-btn" onclick="deleteSite(' + site.id + ')">Delete</button>' +
                    '</td>' +
                '</tr>';
            }).join('');
        }

        function updateSiteSelect() {
            var select = document.getElementById('siteSelect');
            select.innerHTML = '<option value="">Choose a site...</option>' +
                sites.map(function(site) {
                    return '<option value="' + site.id + '">' + site.name + '</option>';
                }).join('');
        }

        // Worker Management
        function addWorker() {
            // Get worker details
            var name = prompt("Enter worker name:");
            if (!name || !name.trim()) return;

            var phone = prompt("Enter contact number:");
            if (!phone || !phone.trim()) return;

            var isPermanent = confirm("Is this a permanent worker?\nClick OK for Permanent, Cancel for Temporary");

            var wage = prompt("Enter daily wage in Rand (R):");
            if (!wage || isNaN(wage)) return;

            // Add new worker
            workers.push({
                id: Date.now(),
                name: name.trim(),
                phone: phone.trim(),
                isPermanent: isPermanent,
                wage: parseFloat(wage)
            });

            updateWorkersList();
            updateWorkerSelect();
        }

        function editWorker(workerId) {
            var worker = workers.find(function(w) { return w.id === workerId; });
            if (!worker) return;

            // Get updated details
            var name = prompt("Edit worker name:", worker.name);
            if (!name || !name.trim()) return;

            var phone = prompt("Edit contact number:", worker.phone);
            if (!phone || !phone.trim()) return;

            var isPermanent = confirm("Is this a permanent worker?\nClick OK for Permanent, Cancel for Temporary");

            var wage = prompt("Edit daily wage in Rand (R):", worker.wage);
            if (!wage || isNaN(wage)) return;

            // Update worker
            worker.name = name.trim();
            worker.phone = phone.trim();
            worker.isPermanent = isPermanent;
            worker.wage = parseFloat(wage);

            updateWorkersList();
            updateWorkerSelect();
            updateCurrentAssignments();
        }

        function deleteWorker(workerId) {
            if (!confirm("Are you sure you want to delete this worker?")) return;

            // Remove worker and their assignments
            workers = workers.filter(function(w) { return w.id !== workerId; });
            Object.keys(assignments).forEach(function(date) {
                if (assignments[date]['workers'] && assignments[date]['workers'][workerId]) {
                    delete assignments[date]['workers'][workerId];
                }
            });

            updateWorkersList();
            updateWorkerSelect();
            updateCurrentAssignments();
        }

        function updateWorkersList() {
            var tbody = document.getElementById('workersList');
            tbody.innerHTML = workers.map(function(worker) {
                return '<tr>' +
                    '<td>' + worker.name + '</td>' +
                    '<td>' + (worker.isPermanent ? 'Permanent' : 'Temporary') + '</td>' +
                    '<td>' + worker.phone + '</td>' +
                    '<td>' + formatCurrency(worker.wage) + '</td>' +
                    '<td>' +
                        '<button class="edit-btn" onclick="editWorker(' + worker.id + ')">Edit</button>' +
                        '<button class="delete-btn" onclick="deleteWorker(' + worker.id + ')">Delete</button>' +
                    '</td>' +
                '</tr>';
            }).join('');
        }

        function updateWorkerSelect() {
            var select = document.getElementById('workerSelect');
            var date = document.getElementById('currentDate').value;
            var siteId = document.getElementById('siteSelect').value;

            // Get already assigned workers for this date and site
            var assignedWorkerIds = new Set();
            if (assignments[date] && assignments[date]['workers']) {
                Object.keys(assignments[date]['workers']).forEach(function(workerId) {
                    if (assignments[date]['workers'][workerId].siteId == siteId) {
                        assignedWorkerIds.add(parseInt(workerId));
                    }
                });
            }

            // Show only available workers
            var availableWorkers = workers.filter(function(w) { return !assignedWorkerIds.has(w.id); });
            select.innerHTML = '<option value="">Choose a worker...</option>' +
                availableWorkers.map(function(worker) {
                    return '<option value="' + worker.id + '">' +
                        worker.name + ' (' + (worker.isPermanent ? 'Permanent' : 'Temporary') + ')' +
                    '</option>';
                }).join('');
        }

        // Sub Contractor Management
        function addSubContractor() {
            // Type of work
            var typeOfWorkOptions = ["Brickwork", "Plaster", "Carpentry"];
            var typeOfWork = prompt("Select Type of Work:\n1. Brickwork\n2. Plaster\n3. Carpentry");
            switch(typeOfWork) {
                case '1':
                    typeOfWork = 'Brickwork';
                    break;
                case '2':
                    typeOfWork = 'Plaster';
                    break;
                case '3':
                    typeOfWork = 'Carpentry';
                    break;
                default:
                    alert("Invalid selection.");
                    return;
            }

            // Sub Contractor Name
            var name = prompt("Enter Sub Contractor Name:");
            if (!name || !name.trim()) return;

            // Number of Workers (+1 to +5)
            var numWorkers = prompt("Enter number of workers (including contractor):\nChoose between 1 and 6");
            numWorkers = parseInt(numWorkers);
            if (isNaN(numWorkers) || numWorkers < 1 || numWorkers > 6) {
                alert("Invalid number of workers.");
                return;
            }

            // Daily Rate
            var dailyRate = prompt("Enter Daily Rate for this Sub Contractor:");
            if (!dailyRate || isNaN(dailyRate)) return;

            // Add new Sub Contractor
            subContractors.push({
                id: Date.now(),
                typeOfWork: typeOfWork,
                name: name.trim(),
                numWorkers: numWorkers,
                dailyRate: parseFloat(dailyRate)
            });

            updateSubContractorsList();
            updateSubContractorSelect();
        }

        function editSubContractor(subContractorId) {
            var sc = subContractors.find(function(s) { return s.id === subContractorId; });
            if (!sc) return;

            // Type of work
            var typeOfWork = prompt("Edit Type of Work:\n1. Brickwork\n2. Plaster\n3. Carpentry", sc.typeOfWork);
            switch(typeOfWork) {
                case '1':
                    typeOfWork = 'Brickwork';
                    break;
                case '2':
                    typeOfWork = 'Plaster';
                    break;
                case '3':
                    typeOfWork = 'Carpentry';
                    break;
                default:
                    alert("Invalid selection.");
                    return;
            }

            // Sub Contractor Name
            var name = prompt("Edit Sub Contractor Name:", sc.name);
            if (!name || !name.trim()) return;

            // Number of Workers
            var numWorkers = prompt("Edit number of workers (including contractor):", sc.numWorkers);
            numWorkers = parseInt(numWorkers);
            if (isNaN(numWorkers) || numWorkers < 1 || numWorkers > 6) {
                alert("Invalid number of workers.");
                return;
            }

            // Daily Rate
            var dailyRate = prompt("Edit Daily Rate for this Sub Contractor:", sc.dailyRate);
            if (!dailyRate || isNaN(dailyRate)) return;

            // Update Sub Contractor
            sc.typeOfWork = typeOfWork;
            sc.name = name.trim();
            sc.numWorkers = numWorkers;
            sc.dailyRate = parseFloat(dailyRate);

            updateSubContractorsList();
            updateSubContractorSelect();
            updateCurrentAssignments();
        }

        function deleteSubContractor(subContractorId) {
            if (!confirm("Are you sure you want to delete this Sub Contractor?")) return;

            // Remove Sub Contractor and their assignments
            subContractors = subContractors.filter(function(s) { return s.id !== subContractorId; });
            Object.keys(assignments).forEach(function(date) {
                if (assignments[date]['subContractors'] && assignments[date]['subContractors'][subContractorId]) {
                    delete assignments[date]['subContractors'][subContractorId];
                }
            });

            updateSubContractorsList();
            updateSubContractorSelect();
            updateCurrentAssignments();
        }

        function updateSubContractorsList() {
            var tbody = document.getElementById('subContractorsList');
            tbody.innerHTML = subContractors.map(function(sc) {
                return '<tr>' +
                    '<td>' + sc.typeOfWork + '</td>' +
                    '<td>' + sc.name + '</td>' +
                    '<td>' + sc.numWorkers + '</td>' +
                    '<td>' + formatCurrency(sc.dailyRate) + '</td>' +
                    '<td>' +
                        '<button class="edit-btn" onclick="editSubContractor(' + sc.id + ')">Edit</button>' +
                        '<button class="delete-btn" onclick="deleteSubContractor(' + sc.id + ')">Delete</button>' +
                    '</td>' +
                '</tr>';
            }).join('');
        }

        function updateSubContractorSelect() {
            var select = document.getElementById('subContractorSelect');
            var date = document.getElementById('currentDate').value;
            var siteId = document.getElementById('siteSelect').value;

            // Get already assigned sub contractors for this date and site
            var assignedSubContractorIds = new Set();
            if (assignments[date] && assignments[date]['subContractors']) {
                Object.keys(assignments[date]['subContractors']).forEach(function(scId) {
                    if (assignments[date]['subContractors'][scId].siteId == siteId) {
                        assignedSubContractorIds.add(parseInt(scId));
                    }
                });
            }

            // Show only available sub contractors
            var availableSubContractors = subContractors.filter(function(s) { return !assignedSubContractorIds.has(s.id); });
            select.innerHTML = '<option value="">Choose a sub contractor...</option>' +
                availableSubContractors.map(function(sc) {
                    return '<option value="' + sc.id + '">' +
                        sc.name + ' (' + sc.typeOfWork + ')' +
                    '</option>';
                }).join('');
        }

        // Assignment Management
        function handleDateChange() {
            var siteSelect = document.getElementById('siteSelect');
            var workerSelect = document.getElementById('workerSelect');
            var addWorkerBtn = document.getElementById('addWorkerBtn');
            var subContractorSelect = document.getElementById('subContractorSelect');
            var addSubContractorBtn = document.getElementById('addSubContractorBtn');

            siteSelect.disabled = false;
            workerSelect.disabled = true;
            addWorkerBtn.disabled = true;
            subContractorSelect.disabled = true;
            addSubContractorBtn.disabled = true;

            updateCurrentAssignments();
        }

        function handleSiteChange() {
            var workerSelect = document.getElementById('workerSelect');
            var addWorkerBtn = document.getElementById('addWorkerBtn');
            var subContractorSelect = document.getElementById('subContractorSelect');
            var addSubContractorBtn = document.getElementById('addSubContractorBtn');

            workerSelect.disabled = false;
            addWorkerBtn.disabled = false;
            subContractorSelect.disabled = false;
            addSubContractorBtn.disabled = false;

            updateWorkerSelect();
            updateSubContractorSelect();
            updateCurrentAssignments();
        }

        function assignSelectedWorker() {
            var date = document.getElementById('currentDate').value;
            var siteId = parseInt(document.getElementById('siteSelect').value);
            var workerId = parseInt(document.getElementById('workerSelect').value);

            if (!date || !siteId || !workerId) {
                alert('Please select all required fields');
                return;
            }

            if (!assignments[date]) {
                assignments[date] = { workers: {}, subContractors: {} };
            }
            if (!assignments[date]['workers']) {
                assignments[date]['workers'] = {};
            }

            // Add new assignment with timestamp
            assignments[date]['workers'][workerId] = {
                siteId: siteId,
                present: true,
                timestamp: Date.now()
            };

            // Reset worker select but keep it enabled
            document.getElementById('workerSelect').value = '';
            updateCurrentAssignments();
            updateWorkerSelect();
        }

        function assignSelectedSubContractor() {
            var date = document.getElementById('currentDate').value;
            var siteId = parseInt(document.getElementById('siteSelect').value);
            var subContractorId = parseInt(document.getElementById('subContractorSelect').value);

            if (!date || !siteId || !subContractorId) {
                alert('Please select all required fields');
                return;
            }

            if (!assignments[date]) {
                assignments[date] = { workers: {}, subContractors: {} };
            }
            if (!assignments[date]['subContractors']) {
                assignments[date]['subContractors'] = {};
            }

            // Add new assignment with timestamp
            assignments[date]['subContractors'][subContractorId] = {
                siteId: siteId,
                present: true,
                timestamp: Date.now()
            };

            // Reset sub contractor select but keep it enabled
            document.getElementById('subContractorSelect').value = '';
            updateCurrentAssignments();
            updateSubContractorSelect();
        }

        function togglePresence(id, isWorker) {
            var date = document.getElementById('currentDate').value;
            var category = isWorker ? 'workers' : 'subContractors';
            if (assignments[date] && assignments[date][category] && assignments[date][category][id]) {
                assignments[date][category][id].present = !assignments[date][category][id].present;
                updateCurrentAssignments();
            }
        }

        function removeAssignment(id, isWorker) {
            var date = document.getElementById('currentDate').value;
            var category = isWorker ? 'workers' : 'subContractors';
            if (assignments[date] && assignments[date][category] && assignments[date][category][id]) {
                delete assignments[date][category][id];
                updateCurrentAssignments();
                if (isWorker) {
                    updateWorkerSelect();
                } else {
                    updateSubContractorSelect();
                }
            }
        }

        function updateCurrentAssignments() {
            var date = document.getElementById('currentDate').value;
            var siteId = parseInt(document.getElementById('siteSelect').value);
            var div = document.getElementById('currentAssignments');

            if (!date || !siteId) {
                div.innerHTML = '';
                return;
            }

            var site = sites.find(function(s) { return s.id === siteId; });
            if (!site) return;

            var html = '<h3>Current Assignments for ' + site.name + ' on ' + new Date(date).toDateString() + '</h3>';

            // Workers Table
            html += '<h4>Workers</h4>' +
                '<table>' +
                '<tr>' +
                    '<th>Present</th>' +
                    '<th>Worker Name</th>' +
                    '<th>Type</th>' +
                    '<th>Contact</th>' +
                    '<th>Wage</th>' +
                    '<th>Time Added</th>' +
                    '<th>Actions</th>' +
                '</tr>';

            // Get current worker assignments and sort by timestamp (newest first)
            var currentWorkerAssignments = assignments[date] && assignments[date]['workers'] ? assignments[date]['workers'] : {};
            var sortedWorkerAssignments = Object.entries(currentWorkerAssignments)
                .filter(function(entry) { return entry[1].siteId === siteId; })
                .sort(function(a, b) { return b[1].timestamp - a[1].timestamp; });

            sortedWorkerAssignments.forEach(function(entry) {
                var workerId = entry[0];
                var assignment = entry[1];
                var worker = workers.find(function(w) { return w.id === parseInt(workerId); });
                if (worker) {
                    html += '<tr class="' + (assignment.present ? 'present' : 'absent') + '">' +
                        '<td>' +
                            '<input type="checkbox" ' +
                                (assignment.present ? 'checked' : '') + 
                                ' onchange="togglePresence(' + worker.id + ', true)">' +
                        '</td>' +
                        '<td>' + worker.name + '</td>' +
                        '<td>' + (worker.isPermanent ? 'Permanent' : 'Temporary') + '</td>' +
                        '<td>' + worker.phone + '</td>' +
                        '<td>' + formatCurrency(worker.wage) + '</td>' +
                        '<td><span class="timestamp">' +
                            new Date(assignment.timestamp).toLocaleTimeString() +
                        '</span></td>' +
                        '<td>' +
                            '<button class="delete-btn" onclick="removeAssignment(' + worker.id + ', true)">' +
                                'Remove' +
                            '</button>' +
                        '</td>' +
                    '</tr>';
                }
            });

            html += '</table>';

            // Sub Contractors Table
            html += '<h4>Sub Contractors</h4>' +
                '<table>' +
                '<tr>' +
                    '<th>Present</th>' +
                    '<th>Type of Work</th>' +
                    '<th>Name</th>' +
                    '<th>Number of Workers</th>' +
                    '<th>Daily Rate</th>' +
                    '<th>Time Added</th>' +
                    '<th>Actions</th>' +
                '</tr>';

            var currentSubContractorAssignments = assignments[date] && assignments[date]['subContractors'] ? assignments[date]['subContractors'] : {};
            var sortedSubContractorAssignments = Object.entries(currentSubContractorAssignments)
                .filter(function(entry) { return entry[1].siteId === siteId; })
                .sort(function(a, b) { return b[1].timestamp - a[1].timestamp; });

            sortedSubContractorAssignments.forEach(function(entry) {
                var scId = entry[0];
                var assignment = entry[1];
                var sc = subContractors.find(function(s) { return s.id === parseInt(scId); });
                if (sc) {
                    html += '<tr class="' + (assignment.present ? 'present' : 'absent') + '">' +
                        '<td>' +
                            '<input type="checkbox" ' +
                                (assignment.present ? 'checked' : '') + 
                                ' onchange="togglePresence(' + sc.id + ', false)">' +
                        '</td>' +
                        '<td>' + sc.typeOfWork + '</td>' +
                        '<td>' + sc.name + '</td>' +
                        '<td>' + sc.numWorkers + '</td>' +
                        '<td>' + formatCurrency(sc.dailyRate) + '</td>' +
                        '<td><span class="timestamp">' +
                            new Date(assignment.timestamp).toLocaleTimeString() +
                        '</span></td>' +
                        '<td>' +
                            '<button class="delete-btn" onclick="removeAssignment(' + sc.id + ', false)">' +
                                'Remove' +
                            '</button>' +
                        '</td>' +
                    '</tr>';
                }
            });

            html += '</table>';
            div.innerHTML = html;
        }

        // Report Generation
        // (Update these functions as needed to include sub contractors in the reports)

        // Helper Functions for Weekly Report
        function getStartDateOfWeek(year, week) {
            var simple = new Date(year, 0, 1 + (week - 1) * 7);
            var dow = simple.getDay();
            var ISOweekStart = simple;
            if (dow <= 4)
                ISOweekStart.setDate(simple.getDate() - simple.getDay() + 1);
            else
                ISOweekStart.setDate(simple.getDate() + 8 - simple.getDay());
            return ISOweekStart;
        }

        function getDatesOfWeek(startDate) {
            var dates = [];
            for (var i = 0; i < 7; i++) {
                var date = new Date(startDate);
                date.setDate(startDate.getDate() + i);
                dates.push(date);
            }
            return dates;
        }
    </script>
</body>
</html>
