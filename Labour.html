<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Construction Labor Management System</title>
    <style>
        /* Your existing CSS styles here */
        body { 
            font-family: Arial, sans-serif; 
            padding: 20px; 
            max-width: 1200px; 
            margin: 0 auto;
            background-color: #f5f5f5;
        }

        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .section-header {
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Buttons */
        button { 
            padding: 8px 16px; 
            color: white; 
            border: none; 
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }

        .primary-btn {
            background-color: #4CAF50;
        }

        .primary-btn:hover {
            background-color: #45a049;
        }

        .edit-btn {
            background-color: #2196F3;
            padding: 4px 12px;
        }

        .edit-btn:hover {
            background-color: #1976D2;
        }

        .delete-btn {
            background-color: #f44336;
            padding: 4px 12px;
        }

        .delete-btn:hover {
            background-color: #d32f2f;
        }

        .add-btn {
            background-color: #ff9800;
            padding: 8px 16px;
        }

        .add-btn:hover {
            background-color: #f57c00;
        }

        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
            background: white;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }

        th {
            background-color: #f5f5f5;
            font-weight: bold;
        }

        tr:hover {
            background-color: #f9f9f9;
        }

        /* Status Classes */
        .present { 
            background-color: #e8f5e9; 
        }

        .present:hover { 
            background-color: #c8e6c9; 
        }

        .absent { 
            background-color: #ffebee; 
        }

        .absent:hover { 
            background-color: #ffcdd2; 
        }

        /* Form Controls */
        .controls-group {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .control-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        select, input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            min-width: 200px;
        }

        select:disabled {
            background-color: #f5f5f5;
            cursor: not-allowed;
        }

        /* Assignment Section */
        .assignment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .timestamp {
            color: #666;
            font-size: 0.9em;
        }

        /* Reports Section */
        .reports-container {
            margin-top: 20px;
            padding: 15px;
            border-top: 1px solid #ddd;
        }

        .total-row {
            font-weight: bold;
            background-color: #f5f5f5;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .controls-group {
                flex-direction: column;
                align-items: stretch;
            }

            select, input {
                width: 100%;
                min-width: unset;
            }

            table {
                display: block;
                overflow-x: auto;
            }
        }
    </style>
</head>
<body>
    <h1>Construction Labor Management System</h1>

    <!-- Setup Section -->
    <div class="container">
        <div class="section-header">
            <h2>Initial Setup</h2>
            <div>
                <button class="primary-btn" onclick="addSite()">Add Site</button>
                <button class="primary-btn" onclick="addWorker()">Add Worker</button>
            </div>
        </div>

        <!-- Sites Table -->
        <h3>Construction Sites</h3>
        <table>
            <thead>
                <tr>
                    <th>Site Name</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="sitesList"></tbody>
        </table>

        <!-- Workers Table -->
        <h3>Workers</h3>
        <table>
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Type</th>
                    <th>Contact</th>
                    <th>Daily Wage</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="workersList"></tbody>
        </table>
    </div>

    <!-- Daily Assignment Section -->
    <div class="container">
        <div class="section-header">
            <h2>Daily Labor Assignment</h2>
        </div>

        <div class="controls-group">
            <div class="control-item">
                <label>1. Select Date:</label>
                <input type="date" id="currentDate" onchange="handleDateChange()">
            </div>
            <div class="control-item">
                <label>2. Select Site:</label>
                <select id="siteSelect" onchange="handleSiteChange()" disabled>
                    <option value="">Choose a site...</option>
                </select>
            </div>
            <div class="control-item">
                <label>3. Select Worker:</label>
                <select id="workerSelect" disabled>
                    <option value="">Choose a worker...</option>
                </select>
            </div>
            <button id="addWorkerBtn" class="add-btn" onclick="assignSelectedWorker()" disabled>
                Add Worker
            </button>
        </div>

        <div id="currentAssignments"></div>
    </div>

    <!-- Reports Section -->
    <div class="container">
        <div class="section-header">
            <h2>Reports</h2>
        </div>

        <div class="controls-group">
            <div class="control-item">
                <label>Select Week:</label>
                <input type="week" id="weekSelect">
            </div>
            <button class="primary-btn" onclick="showDailyReport()">Daily Report</button>
            <button class="primary-btn" onclick="showWeeklyReport()">Weekly Report</button>
        </div>

        <div id="reportArea"></div>
    </div>

    <!-- JavaScript Code -->
    <script>
        // Data Storage
        var sites = [];
        var workers = [];
        var assignments = {};

        // Initialize the page
        function initializePage() {
            document.getElementById('currentDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('weekSelect').value = getCurrentWeek();
            updateSitesList();
            updateWorkersList();
        }

        // Call initializePage when the window loads
        window.onload = initializePage;

        // Helper Functions
        function getCurrentWeek() {
            var now = new Date();
            var onejan = new Date(now.getFullYear(), 0, 1);
            var week = Math.ceil((((now - onejan) / 86400000) + onejan.getDay() + 1) / 7);
            return now.getFullYear() + '-W' + week.toString().padStart(2, '0');
        }

        function formatCurrency(amount) {
            return 'R' + parseFloat(amount).toFixed(2);
        }

        // Site Management
        function addSite() {
            var name = prompt("Enter site name:");
            if (name && name.trim()) {
                sites.push({
                    id: Date.now(),
                    name: name.trim()
                });
                updateSitesList();
                updateSiteSelect();
            }
        }

        function editSite(siteId) {
            var site = sites.find(function(s) { return s.id === siteId; });
            if (!site) return;

            var newName = prompt("Edit site name:", site.name);
            if (newName && newName.trim() && newName !== site.name) {
                site.name = newName.trim();
                updateSitesList();
                updateSiteSelect();
            }
        }

        function deleteSite(siteId) {
            if (!confirm("Are you sure you want to delete this site?")) return;
            
            // Remove site and its assignments
            sites = sites.filter(function(s) { return s.id !== siteId; });
            Object.keys(assignments).forEach(function(date) {
                Object.keys(assignments[date]).forEach(function(workerId) {
                    if (assignments[date][workerId].siteId === siteId) {
                        delete assignments[date][workerId];
                    }
                });
            });

            updateSitesList();
            updateSiteSelect();
            updateCurrentAssignments();
        }

        function updateSitesList() {
            var tbody = document.getElementById('sitesList');
            tbody.innerHTML = sites.map(function(site) {
                return '<tr>' +
                    '<td>' + site.name + '</td>' +
                    '<td>' +
                        '<button class="edit-btn" onclick="editSite(' + site.id + ')">Edit</button>' +
                        '<button class="delete-btn" onclick="deleteSite(' + site.id + ')">Delete</button>' +
                    '</td>' +
                '</tr>';
            }).join('');
        }

        // Worker Management
        function addWorker() {
            // Get worker details
            var name = prompt("Enter worker name:");
            if (!name || !name.trim()) return;

            var phone = prompt("Enter contact number:");
            if (!phone || !phone.trim()) return;

            var isPermanent = confirm("Is this a permanent worker?\nClick OK for Permanent, Cancel for Temporary");

            var wage = prompt("Enter daily wage in Rand (R):");
            if (!wage || isNaN(wage)) return;

            // Add new worker
            workers.push({
                id: Date.now(),
                name: name.trim(),
                phone: phone.trim(),
                isPermanent: isPermanent,
                wage: parseFloat(wage)
            });

            updateWorkersList();
            updateWorkerSelect();
        }

        function editWorker(workerId) {
            var worker = workers.find(function(w) { return w.id === workerId; });
            if (!worker) return;

            // Get updated details
            var name = prompt("Edit worker name:", worker.name);
            if (!name || !name.trim()) return;

            var phone = prompt("Edit contact number:", worker.phone);
            if (!phone || !phone.trim()) return;

            var isPermanent = confirm("Is this a permanent worker?\nClick OK for Permanent, Cancel for Temporary");

            var wage = prompt("Edit daily wage in Rand (R):", worker.wage);
            if (!wage || isNaN(wage)) return;

            // Update worker
            worker.name = name.trim();
            worker.phone = phone.trim();
            worker.isPermanent = isPermanent;
            worker.wage = parseFloat(wage);

            updateWorkersList();
            updateWorkerSelect();
            updateCurrentAssignments();
        }

        function deleteWorker(workerId) {
            if (!confirm("Are you sure you want to delete this worker?")) return;

            // Remove worker and their assignments
            workers = workers.filter(function(w) { return w.id !== workerId; });
            Object.keys(assignments).forEach(function(date) {
                if (assignments[date][workerId]) {
                    delete assignments[date][workerId];
                }
            });

            updateWorkersList();
            updateWorkerSelect();
            updateCurrentAssignments();
        }

        function updateWorkersList() {
            var tbody = document.getElementById('workersList');
            tbody.innerHTML = workers.map(function(worker) {
                return '<tr>' +
                    '<td>' + worker.name + '</td>' +
                    '<td>' + (worker.isPermanent ? 'Permanent' : 'Temporary') + '</td>' +
                    '<td>' + worker.phone + '</td>' +
                    '<td>' + formatCurrency(worker.wage) + '</td>' +
                    '<td>' +
                        '<button class="edit-btn" onclick="editWorker(' + worker.id + ')">Edit</button>' +
                        '<button class="delete-btn" onclick="deleteWorker(' + worker.id + ')">Delete</button>' +
                    '</td>' +
                '</tr>';
            }).join('');
        }

        // Dropdown Management
        function updateSiteSelect() {
            var select = document.getElementById('siteSelect');
            select.innerHTML = '<option value="">Choose a site...</option>' +
                sites.map(function(site) {
                    return '<option value="' + site.id + '">' + site.name + '</option>';
                }).join('');
        }

        function updateWorkerSelect() {
            var select = document.getElementById('workerSelect');
            var date = document.getElementById('currentDate').value;
            var siteId = document.getElementById('siteSelect').value;

            // Get already assigned workers for this date
            var assignedWorkerIds = new Set();
            if (assignments[date]) {
                Object.keys(assignments[date]).forEach(function(workerId) {
                    assignedWorkerIds.add(parseInt(workerId));
                });
            }

            // Show only available workers
            var availableWorkers = workers.filter(function(w) { return !assignedWorkerIds.has(w.id); });
            select.innerHTML = '<option value="">Choose a worker...</option>' +
                availableWorkers.map(function(worker) {
                    return '<option value="' + worker.id + '">' +
                        worker.name + ' (' + (worker.isPermanent ? 'Permanent' : 'Temporary') + ')' +
                    '</option>';
                }).join('');
        }

        // Daily Assignment Management
        function handleDateChange() {
            var siteSelect = document.getElementById('siteSelect');
            var workerSelect = document.getElementById('workerSelect');
            var addWorkerBtn = document.getElementById('addWorkerBtn');
            
            siteSelect.disabled = false;
            workerSelect.disabled = true;
            addWorkerBtn.disabled = true;
            
            updateCurrentAssignments();
        }

        function handleSiteChange() {
            var workerSelect = document.getElementById('workerSelect');
            var addWorkerBtn = document.getElementById('addWorkerBtn');
            
            workerSelect.disabled = false;
            addWorkerBtn.disabled = false;
            
            updateWorkerSelect();
            updateCurrentAssignments();
        }

        function assignSelectedWorker() {
            var date = document.getElementById('currentDate').value;
            var siteId = parseInt(document.getElementById('siteSelect').value);
            var workerId = parseInt(document.getElementById('workerSelect').value);

            if (!date || !siteId || !workerId) {
                alert('Please select all required fields');
                return;
            }

            if (!assignments[date]) {
                assignments[date] = {};
            }

            // Add new assignment with timestamp
            assignments[date][workerId] = {
                siteId: siteId,
                present: true,
                timestamp: Date.now()
            };

            // Reset worker select but keep it enabled
            document.getElementById('workerSelect').value = '';
            updateCurrentAssignments();
            updateWorkerSelect();
        }

        function togglePresence(workerId) {
            var date = document.getElementById('currentDate').value;
            if (assignments[date] && assignments[date][workerId]) {
                assignments[date][workerId].present = !assignments[date][workerId].present;
                updateCurrentAssignments();
            }
        }

        function removeAssignment(workerId) {
            var date = document.getElementById('currentDate').value;
            if (assignments[date] && assignments[date][workerId]) {
                delete assignments[date][workerId];
                updateCurrentAssignments();
                updateWorkerSelect();
            }
        }

        function updateCurrentAssignments() {
            var date = document.getElementById('currentDate').value;
            var siteId = parseInt(document.getElementById('siteSelect').value);
            var div = document.getElementById('currentAssignments');

            if (!date || !siteId) {
                div.innerHTML = '';
                return;
            }

            var site = sites.find(function(s) { return s.id === siteId; });
            if (!site) return;

            var html = '<h3>Current Assignments for ' + site.name + ' on ' + new Date(date).toDateString() + '</h3>' +
                '<table>' +
                '<tr>' +
                    '<th>Present</th>' +
                    '<th>Worker Name</th>' +
                    '<th>Type</th>' +
                    '<th>Contact</th>' +
                    '<th>Wage</th>' +
                    '<th>Time Added</th>' +
                    '<th>Actions</th>' +
                '</tr>';

            // Get current assignments and sort by timestamp (newest first)
            var currentAssignments = assignments[date] || {};
            var sortedAssignments = Object.entries(currentAssignments)
                .filter(function(entry) { return entry[1].siteId === siteId; })
                .sort(function(a, b) { return b[1].timestamp - a[1].timestamp; });

            sortedAssignments.forEach(function(entry) {
                var workerId = entry[0];
                var assignment = entry[1];
                var worker = workers.find(function(w) { return w.id === parseInt(workerId); });
                if (worker) {
                    html += '<tr class="' + (assignment.present ? 'present' : 'absent') + '">' +
                        '<td>' +
                            '<input type="checkbox" ' +
                                (assignment.present ? 'checked' : '') + 
                                ' onchange="togglePresence(' + worker.id + ')">' +
                        '</td>' +
                        '<td>' + worker.name + '</td>' +
                        '<td>' + (worker.isPermanent ? 'Permanent' : 'Temporary') + '</td>' +
                        '<td>' + worker.phone + '</td>' +
                        '<td>' + formatCurrency(worker.wage) + '</td>' +
                        '<td><span class="timestamp">' +
                            new Date(assignment.timestamp).toLocaleTimeString() +
                        '</span></td>' +
                        '<td>' +
                            '<button class="delete-btn" onclick="removeAssignment(' + worker.id + ')">' +
                                'Remove' +
                            '</button>' +
                        '</td>' +
                    '</tr>';
                }
            });

            html += '</table>';
            div.innerHTML = html;
        }

        // Report Generation
        function showDailyReport() {
            var date = document.getElementById('currentDate').value;
            var html = '<h3>Daily Report - ' + new Date(date).toDateString() + '</h3>';
            
            html += '<table>' +
                '<tr>' +
                    '<th>Site</th>' +
                    '<th>Worker</th>' +
                    '<th>Type</th>' +
                    '<th>Status</th>' +
                    '<th>Wage</th>' +
                '</tr>';

            sites.forEach(function(site) {
                var siteTotal = 0;
                var hasSiteData = false;

                Object.entries(assignments[date] || {}).forEach(function(entry) {
                    var workerId = entry[0];
                    var assignment = entry[1];
                    if (assignment.siteId === site.id) {
                        var worker = workers.find(function(w) { return w.id === parseInt(workerId); });
                        if (worker) {
                            hasSiteData = true;
                            if (assignment.present) {
                                siteTotal += worker.wage;
                            }
                            html += '<tr class="' + (assignment.present ? 'present' : 'absent') + '">' +
                                '<td>' + site.name + '</td>' +
                                '<td>' + worker.name + '</td>' +
                                '<td>' + (worker.isPermanent ? 'Permanent' : 'Temporary') + '</td>' +
                                '<td>' + (assignment.present ? 'Present' : 'Absent') + '</td>' +
                                '<td>' + (assignment.present ? formatCurrency(worker.wage) : '-') + '</td>' +
                            '</tr>';
                        }
                    }
                });

                if (hasSiteData) {
                    html += '<tr class="total-row">' +
                        '<td colspan="4"><strong>' + site.name + ' Total</strong></td>' +
                        '<td><strong>' + formatCurrency(siteTotal) + '</strong></td>' +
                    '</tr>';
                }
            });

            html += '</table>';
            document.getElementById('reportArea').innerHTML = html;
        }

        function showWeeklyReport() {
            var weekStr = document.getElementById('weekSelect').value;
            if (!weekStr) {
                alert('Please select a week');
                return;
            }

            var parts = weekStr.split('-W');
            var year = parseInt(parts[0]);
            var week = parseInt(parts[1]);

            var startDate = getStartDateOfWeek(year, week);
            var dates = getDatesOfWeek(startDate);

            var html = '<h3>Weekly Report (' + dates[0].toDateString() + ' to ' + dates[6].toDateString() + ')</h3>' +
                '<table>' +
                '<tr>' +
                    '<th>Site</th>' +
                    '<th>Worker</th>' +
                    '<th>Type</th>' +
                    '<th>Days Present</th>' +
                    '<th>Total Wages</th>' +
                '</tr>';

            var dateStrings = dates.map(function(date) { return date.toISOString().split('T')[0]; });

            sites.forEach(function(site) {
                var siteTotal = 0;
                var workerData = new Map();

                dateStrings.forEach(function(date) {
                    Object.entries(assignments[date] || {}).forEach(function(entry) {
                        var workerId = entry[0];
                        var assignment = entry[1];
                        if (assignment.siteId === site.id) {
                            var worker = workers.find(function(w) { return w.id === parseInt(workerId); });
                            if (worker) {
                                if (!workerData.has(workerId)) {
                                    workerData.set(workerId, {
                                        name: worker.name,
                                        type: worker.isPermanent ? 'Permanent' : 'Temporary',
                                        daysPresent: 0,
                                        totalWages: 0
                                    });
                                }
                                
                                var data = workerData.get(workerId);
                                if (assignment.present) {
                                    data.daysPresent++;
                                    data.totalWages += worker.wage;
                                    siteTotal += worker.wage;
                                }
                            }
                        }
                    });
                });

                if (workerData.size > 0) {
                    workerData.forEach(function(data) {
                        html += '<tr>' +
                            '<td>' + site.name + '</td>' +
                            '<td>' + data.name + '</td>' +
                            '<td>' + data.type + '</td>' +
                            '<td>' + data.daysPresent + '</td>' +
                            '<td>' + formatCurrency(data.totalWages) + '</td>' +
                        '</tr>';
                    });

                    html += '<tr class="total-row">' +
                        '<td colspan="4"><strong>' + site.name + ' Total</strong></td>' +
                        '<td><strong>' + formatCurrency(siteTotal) + '</strong></td>' +
                    '</tr>';
                }
            });

            html += '</table>';
            document.getElementById('reportArea').innerHTML = html;
        }

        // Helper Functions for Weekly Report
        function getStartDateOfWeek(year, week) {
            var simple = new Date(year, 0, 1 + (week - 1) * 7);
            var dow = simple.getDay();
            var ISOweekStart = simple;
            if (dow <= 4)
                ISOweekStart.setDate(simple.getDate() - simple.getDay() + 1);
            else
                ISOweekStart.setDate(simple.getDate() + 8 - simple.getDay());
            return ISOweekStart;
        }

        function getDatesOfWeek(startDate) {
            var dates = [];
            for (var i = 0; i < 7; i++) {
                var date = new Date(startDate);
                date.setDate(startDate.getDate() + i);
                dates.push(date);
            }
            return dates;
        }
    </script>
</body>
</html>
