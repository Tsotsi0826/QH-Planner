<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Construction Labor Management System</title>
    <style>
        /* Existing CSS styles here */
        body { 
            font-family: Arial, sans-serif; 
            padding: 20px; 
            max-width: 1200px; 
            margin: 0 auto;
            background-color: #f5f5f5;
        }

        /* Updated styles for the top navigation */
        .top-nav {
            display: flex;
            justify-content: flex-start;
            margin-bottom: 10px;
        }

        .home-btn {
            display: flex;
            align-items: center;
            padding: 8px 16px;
            color: #2196F3;
            background-color: transparent;
            text-decoration: none;
            border-radius: 4px;
            font-size: 24px;
            transition: background-color 0.2s;
        }

        .home-btn:hover {
            background-color: #e0e0e0;
        }

        .home-btn span {
            font-size: 24px;
        }

        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .section-header {
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Buttons */
        button { 
            padding: 8px 16px; 
            color: white; 
            border: none; 
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }

        .primary-btn {
            background-color: #4CAF50;
        }

        .primary-btn:hover {
            background-color: #45a049;
        }

        .edit-btn {
            background-color: #2196F3;
            padding: 4px 12px;
        }

        .edit-btn:hover {
            background-color: #1976D2;
        }

        .delete-btn {
            background-color: #f44336;
            padding: 4px 12px;
        }

        .delete-btn:hover {
            background-color: #d32f2f;
        }

        .add-btn {
            background-color: #ff9800;
            padding: 8px 16px;
        }

        .add-btn:hover {
            background-color: #f57c00;
        }

        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
            background: white;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }

        th {
            background-color: #f5f5f5;
            font-weight: bold;
        }

        tr:hover {
            background-color: #f9f9f9;
        }

        /* Status Classes */
        .present { 
            background-color: #e8f5e9; 
        }

        .present:hover { 
            background-color: #c8e6c9; 
        }

        .absent { 
            background-color: #ffebee; 
        }

        .absent:hover { 
            background-color: #ffcdd2; 
        }

        /* Form Controls */
        .controls-group {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .control-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        select, input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            min-width: 200px;
        }

        select:disabled {
            background-color: #f5f5f5;
            cursor: not-allowed;
        }

        /* Assignment Section */
        .assignment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .timestamp {
            color: #666;
            font-size: 0.9em;
        }

        /* Reports Section */
        .reports-container {
            margin-top: 20px;
            padding: 15px;
            border-top: 1px solid #ddd;
        }

        .total-row {
            font-weight: bold;
            background-color: #f5f5f5;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .controls-group {
                flex-direction: column;
                align-items: stretch;
            }

            select, input {
                width: 100%;
                min-width: unset;
            }

            table {
                display: block;
                overflow-x: auto;
            }

            /* Adjust top navigation for mobile */
            .top-nav {
                justify-content: center;
            }
        }
    </style>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>
<body>
    <!-- Top Navigation with Home Icon -->
    <div class="top-nav">
        <a href="index.html" class="home-btn" aria-label="Home">
            <span>üè†</span>
        </a>
    </div>

    <h1>Construction Labor Management System</h1>

    <!-- Setup Section -->
    <div class="container">
        <div class="section-header">
            <h2>Initial Setup</h2>
            <div>
                <button class="primary-btn" onclick="addSite()">Add Site</button>
                <button class="primary-btn" onclick="addWorker()">Add Worker</button>
                <button class="primary-btn" onclick="addSubContractor()">Add Sub Contractor</button>
            </div>
        </div>

        <!-- Sites Table -->
        <h3>Construction Sites</h3>
        <table>
            <thead>
                <tr>
                    <th>Site Name</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="sitesList"></tbody>
        </table>

        <!-- Workers Table -->
        <h3>Workers</h3>
        <table>
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Type</th>
                    <th>Contact</th>
                    <th>Daily Wage</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="workersList"></tbody>
        </table>

        <!-- Sub Contractors Table -->
        <h3>Sub Contractors</h3>
        <table>
            <thead>
                <tr>
                    <th>Type of Work</th>
                    <th>Name</th>
                    <th>Number of Workers</th>
                    <th>Daily Rate</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="subContractorsList"></tbody>
        </table>
    </div>

    <!-- Daily Assignment Section -->
    <div class="container">
        <div class="section-header">
            <h2>Daily Labor Assignment</h2>
        </div>

        <div class="controls-group">
            <div class="control-item">
                <label>1. Select Date:</label>
                <input type="date" id="currentDate" onchange="handleDateChange()">
            </div>
            <div class="control-item">
                <label>2. Select Site:</label>
                <select id="siteSelect" onchange="handleSiteChange()" disabled>
                    <option value="">Choose a site...</option>
                </select>
            </div>
            <div class="control-item">
                <label>3. Select Worker:</label>
                <select id="workerSelect" disabled>
                    <option value="">Choose a worker...</option>
                </select>
            </div>
            <button id="addWorkerBtn" class="add-btn" onclick="assignSelectedWorker()" disabled>
                Add Worker
            </button>
            <div class="control-item">
                <label>4. Select Sub Contractor:</label>
                <select id="subContractorSelect" disabled>
                    <option value="">Choose a sub contractor...</option>
                </select>
            </div>
            <button id="addSubContractorBtn" class="add-btn" onclick="assignSelectedSubContractor()" disabled>
                Add Sub Contractor
            </button>
        </div>

        <div id="currentAssignments"></div>
    </div>

    <!-- Reports Section -->
    <div class="container">
        <div class="section-header">
            <h2>Reports</h2>
        </div>

        <div class="controls-group">
            <div class="control-item">
                <label>Select Week:</label>
                <input type="week" id="weekSelect">
            </div>
            <button class="primary-btn" onclick="showDailyReport()">Daily Report</button>
            <button class="primary-btn" onclick="showWeeklyReport()">Weekly Report</button>
        </div>

        <div id="reportArea"></div>
    </div>

    <!-- JavaScript Code -->
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD82WxYqaYASCiTmcBd7nHHZMTsAJSZkIc",
            authDomain: "qh-planner.firebaseapp.com",
            databaseURL: "https://qh-planner-default-rtdb.firebaseio.com",
            projectId: "qh-planner",
            storageBucket: "qh-planner.appspot.com",
            messagingSenderId: "847763991357",
            appId: "1:847763991357:web:9dda19dfee4dac66a5f354"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Data Storage
        var sites = [];
        var workers = [];
        var subContractors = [];
        var assignments = {};

        // Initialize the page
        function initializePage() {
            document.getElementById('currentDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('weekSelect').value = getCurrentWeek();
            fetchSites();
            fetchWorkers();
            fetchSubContractors();
        }

        // Call initializePage when the window loads
        window.onload = initializePage;

        // Helper Functions
        function getCurrentWeek() {
            var now = new Date();
            var onejan = new Date(now.getFullYear(), 0, 1);
            var week = Math.ceil((((now - onejan) / 86400000) + onejan.getDay() + 1) / 7);
            return now.getFullYear() + '-W' + week.toString().padStart(2, '0');
        }

        function formatCurrency(amount) {
            return 'R' + parseFloat(amount).toFixed(2);
        }

        // Fetch Sites from Firebase
        function fetchSites() {
            database.ref('Sites').on('value', function(snapshot) {
                sites = [];
                snapshot.forEach(function(childSnapshot) {
                    var site = childSnapshot.val();
                    site.id = childSnapshot.key;
                    sites.push(site);
                });
                updateSitesList();
                updateSiteSelect();
            });
        }

        // Site Management
        function addSite() {
            var siteName = prompt("Enter site name:");
            if (siteName && siteName.trim()) {
                var newSiteRef = database.ref('Sites').push();
                newSiteRef.set({
                    siteName: siteName.trim()
                })
                .then(() => alert("Site added successfully"))
                .catch(error => console.error("Error adding site:", error));
            }
        }

        function editSite(siteId) {
            var site = sites.find(function(s) { return s.id === siteId; });
            if (!site) return;

            var newName = prompt("Edit site name:", site.siteName);
            if (newName && newName.trim() && newName !== site.siteName) {
                database.ref('Sites/' + siteId).update({
                    siteName: newName.trim()
                })
                .then(() => alert("Site updated successfully"))
                .catch(error => console.error("Error updating site:", error));
            }
        }

        function deleteSite(siteId) {
            if (!confirm("Are you sure you want to delete this site?")) return;

            database.ref('Sites/' + siteId).remove()
            .then(() => {
                // Also remove related assignments
                database.ref('Assignments').orderByChild('siteId').equalTo(siteId).once('value', function(snapshot) {
                    snapshot.forEach(function(childSnapshot) {
                        childSnapshot.ref.remove();
                    });
                });
                alert("Site deleted successfully");
            })
            .catch(error => console.error("Error deleting site:", error));
        }

        function updateSitesList() {
            var tbody = document.getElementById('sitesList');
            tbody.innerHTML = sites.map(function(site) {
                return '<tr>' +
                    '<td>' + site.siteName + '</td>' +
                    '<td>' +
                        '<button class="edit-btn" onclick="editSite(\'' + site.id + '\')">Edit</button>' +
                        '<button class="delete-btn" onclick="deleteSite(\'' + site.id + '\')">Delete</button>' +
                    '</td>' +
                '</tr>';
            }).join('');
        }

        function updateSiteSelect() {
            var select = document.getElementById('siteSelect');
            select.innerHTML = '<option value="">Choose a site...</option>' +
                sites.map(function(site) {
                    return '<option value="' + site.id + '">' + site.siteName + '</option>';
                }).join('');
        }

        // Fetch Workers from Firebase
        function fetchWorkers() {
            database.ref('Workers').on('value', function(snapshot) {
                workers = [];
                snapshot.forEach(function(childSnapshot) {
                    var worker = childSnapshot.val();
                    worker.id = childSnapshot.key;
                    workers.push(worker);
                });
                updateWorkersList();
                updateWorkerSelect();
            });
        }

        // Worker Management
        function addWorker() {
            const workerName = prompt("Enter worker name:");
            const workerType = prompt("Enter worker type (e.g., Permanent or Temporary):");
            const contact = prompt("Enter worker contact number:");
            const dailyWage = prompt("Enter daily wage in Rand (R):");

            if (workerName && workerType && contact && dailyWage) {
                const newWorkerRef = database.ref('Workers').push();

                newWorkerRef.set({
                    workerName: workerName.trim(),
                    workerType: workerType.trim(),
                    contact: contact.trim(),
                    dailyWage: parseFloat(dailyWage)
                })
                .then(() => alert("Worker added successfully"))
                .catch(error => {
                    console.error("Error adding worker:", error);
                    alert("Failed to add worker. Check console for details.");
                });
            } else {
                alert("Please provide all worker details to proceed.");
            }
        }

        function editWorker(workerId) {
            var worker = workers.find(function(w) { return w.id === workerId; });
            if (!worker) return;

            const workerName = prompt("Edit worker name:", worker.workerName);
            const workerType = prompt("Edit worker type (e.g., Permanent or Temporary):", worker.workerType);
            const contact = prompt("Edit worker contact number:", worker.contact);
            const dailyWage = prompt("Edit daily wage in Rand (R):", worker.dailyWage);

            if (workerName && workerType && contact && dailyWage) {
                database.ref('Workers/' + workerId).update({
                    workerName: workerName.trim(),
                    workerType: workerType.trim(),
                    contact: contact.trim(),
                    dailyWage: parseFloat(dailyWage)
                })
                .then(() => alert("Worker updated successfully"))
                .catch(error => {
                    console.error("Error updating worker:", error);
                    alert("Failed to update worker. Check console for details.");
                });
            } else {
                alert("Please provide all worker details to proceed.");
            }
        }

        function deleteWorker(workerId) {
            if (!confirm("Are you sure you want to delete this worker?")) return;

            database.ref('Workers/' + workerId).remove()
            .then(() => {
                // Also remove related assignments
                database.ref('Assignments').orderByChild('workerId').equalTo(workerId).once('value', function(snapshot) {
                    snapshot.forEach(function(childSnapshot) {
                        childSnapshot.ref.remove();
                    });
                });
                alert("Worker deleted successfully");
            })
            .catch(error => {
                console.error("Error deleting worker:", error);
                alert("Failed to delete worker. Check console for details.");
            });
        }

        function updateWorkersList() {
            var tbody = document.getElementById('workersList');
            tbody.innerHTML = workers.map(function(worker) {
                return '<tr>' +
                    '<td>' + worker.workerName + '</td>' +
                    '<td>' + worker.workerType + '</td>' +
                    '<td>' + worker.contact + '</td>' +
                    '<td>' + formatCurrency(worker.dailyWage) + '</td>' +
                    '<td>' +
                        '<button class="edit-btn" onclick="editWorker(\'' + worker.id + '\')">Edit</button>' +
                        '<button class="delete-btn" onclick="deleteWorker(\'' + worker.id + '\')">Delete</button>' +
                    '</td>' +
                '</tr>';
            }).join('');
        }

        function updateWorkerSelect() {
            var select = document.getElementById('workerSelect');
            var date = document.getElementById('currentDate').value;
            var siteId = document.getElementById('siteSelect').value;

            // Fetch assigned workers for this date and site
            database.ref('Assignments/' + date + '/workers').once('value', function(snapshot) {
                var assignedWorkerIds = [];
                snapshot.forEach(function(childSnapshot) {
                    var assignment = childSnapshot.val();
                    if (assignment.siteId === siteId) {
                        assignedWorkerIds.push(childSnapshot.key);
                    }
                });

                var availableWorkers = workers.filter(function(w) { return assignedWorkerIds.indexOf(w.id) === -1; });
                select.innerHTML = '<option value="">Choose a worker...</option>' +
                    availableWorkers.map(function(worker) {
                        return '<option value="' + worker.id + '">' +
                            worker.workerName + ' (' + worker.workerType + ')' +
                        '</option>';
                    }).join('');
            });
        }

        // Fetch Sub Contractors from Firebase
        function fetchSubContractors() {
            database.ref('Subcontractors').on('value', function(snapshot) {
                subContractors = [];
                snapshot.forEach(function(childSnapshot) {
                    var sc = childSnapshot.val();
                    sc.id = childSnapshot.key;
                    subContractors.push(sc);
                });
                updateSubContractorsList();
                updateSubContractorSelect();
            });
        }

        // Sub Contractor Management
        function addSubContractor() {
            const typeOfWork = prompt("Enter type of work (e.g., Brickwork, Plaster, Carpentry):");
            const contractorName = prompt("Enter subcontractor name:");
            const numOfWorkers = prompt("Enter number of workers (including contractor):");
            const dailyRate = prompt("Enter daily rate for subcontractor in Rand (R):");

            if (typeOfWork && contractorName && numOfWorkers && dailyRate) {
                const newSubcontractorRef = database.ref('Subcontractors').push();
                newSubcontractorRef.set({
                    typeOfWork: typeOfWork.trim(),
                    contractorName: contractorName.trim(),
                    numOfWorkers: parseInt(numOfWorkers),
                    dailyRate: parseFloat(dailyRate)
                })
                .then(() => alert("Subcontractor added successfully"))
                .catch(error => console.error("Error adding subcontractor:", error));
            } else {
                alert("Please provide all subcontractor details to proceed.");
            }
        }

        function editSubContractor(subContractorId) {
            var sc = subContractors.find(function(s) { return s.id === subContractorId; });
            if (!sc) return;

            const typeOfWork = prompt("Edit type of work (e.g., Brickwork, Plaster, Carpentry):", sc.typeOfWork);
            const contractorName = prompt("Edit subcontractor name:", sc.contractorName);
            const numOfWorkers = prompt("Edit number of workers (including contractor):", sc.numOfWorkers);
            const dailyRate = prompt("Edit daily rate for subcontractor in Rand (R):", sc.dailyRate);

            if (typeOfWork && contractorName && numOfWorkers && dailyRate) {
                database.ref('Subcontractors/' + subContractorId).update({
                    typeOfWork: typeOfWork.trim(),
                    contractorName: contractorName.trim(),
                    numOfWorkers: parseInt(numOfWorkers),
                    dailyRate: parseFloat(dailyRate)
                })
                .then(() => alert("Subcontractor updated successfully"))
                .catch(error => console.error("Error updating subcontractor:", error));
            } else {
                alert("Please provide all subcontractor details to proceed.");
            }
        }

        function deleteSubContractor(subContractorId) {
            if (!confirm("Are you sure you want to delete this subcontractor?")) return;

            database.ref('Subcontractors/' + subContractorId).remove()
            .then(() => {
                // Also remove related assignments
                database.ref('Assignments').orderByChild('subContractorId').equalTo(subContractorId).once('value', function(snapshot) {
                    snapshot.forEach(function(childSnapshot) {
                        childSnapshot.ref.remove();
                    });
                });
                alert("Subcontractor deleted successfully");
            })
            .catch(error => console.error("Error deleting subcontractor:", error));
        }

        function updateSubContractorsList() {
            var tbody = document.getElementById('subContractorsList');
            tbody.innerHTML = subContractors.map(function(sc) {
                return '<tr>' +
                    '<td>' + sc.typeOfWork + '</td>' +
                    '<td>' + sc.contractorName + '</td>' +
                    '<td>' + sc.numOfWorkers + '</td>' +
                    '<td>' + formatCurrency(sc.dailyRate) + '</td>' +
                    '<td>' +
                        '<button class="edit-btn" onclick="editSubContractor(\'' + sc.id + '\')">Edit</button>' +
                        '<button class="delete-btn" onclick="deleteSubContractor(\'' + sc.id + '\')">Delete</button>' +
                    '</td>' +
                '</tr>';
            }).join('');
        }

        function updateSubContractorSelect() {
            var select = document.getElementById('subContractorSelect');
            var date = document.getElementById('currentDate').value;
            var siteId = document.getElementById('siteSelect').value;

            // Fetch assigned subcontractors for this date and site
            database.ref('Assignments/' + date + '/subContractors').once('value', function(snapshot) {
                var assignedSubContractorIds = [];
                snapshot.forEach(function(childSnapshot) {
                    var assignment = childSnapshot.val();
                    if (assignment.siteId === siteId) {
                        assignedSubContractorIds.push(childSnapshot.key);
                    }
                });

                var availableSubContractors = subContractors.filter(function(s) { return assignedSubContractorIds.indexOf(s.id) === -1; });
                select.innerHTML = '<option value="">Choose a sub contractor...</option>' +
                    availableSubContractors.map(function(sc) {
                        return '<option value="' + sc.id + '">' +
                            sc.contractorName + ' (' + sc.typeOfWork + ')' +
                        '</option>';
                    }).join('');
            });
        }

        // Assignment Management
        function handleDateChange() {
            var siteSelect = document.getElementById('siteSelect');
            var workerSelect = document.getElementById('workerSelect');
            var addWorkerBtn = document.getElementById('addWorkerBtn');
            var subContractorSelect = document.getElementById('subContractorSelect');
            var addSubContractorBtn = document.getElementById('addSubContractorBtn');

            siteSelect.disabled = false;
            workerSelect.disabled = true;
            addWorkerBtn.disabled = true;
            subContractorSelect.disabled = true;
            addSubContractorBtn.disabled = true;

            updateCurrentAssignments();
        }

        function handleSiteChange() {
            var workerSelect = document.getElementById('workerSelect');
            var addWorkerBtn = document.getElementById('addWorkerBtn');
            var subContractorSelect = document.getElementById('subContractorSelect');
            var addSubContractorBtn = document.getElementById('addSubContractorBtn');

            workerSelect.disabled = false;
            addWorkerBtn.disabled = false;
            subContractorSelect.disabled = false;
            addSubContractorBtn.disabled = false;

            updateWorkerSelect();
            updateSubContractorSelect();
            updateCurrentAssignments();
        }

        function assignSelectedWorker() {
            var date = document.getElementById('currentDate').value;
            var siteId = document.getElementById('siteSelect').value;
            var workerId = document.getElementById('workerSelect').value;

            if (!date || !siteId || !workerId) {
                alert('Please select all required fields');
                return;
            }

            var assignmentRef = database.ref('Assignments/' + date + '/workers/' + workerId);
            assignmentRef.set({
                siteId: siteId,
                present: true,
                timestamp: Date.now()
            })
            .then(() => {
                document.getElementById('workerSelect').value = '';
                updateCurrentAssignments();
                updateWorkerSelect();
            })
            .catch(error => console.error("Error assigning worker:", error));
        }

        function assignSelectedSubContractor() {
            var date = document.getElementById('currentDate').value;
            var siteId = document.getElementById('siteSelect').value;
            var subContractorId = document.getElementById('subContractorSelect').value;

            if (!date || !siteId || !subContractorId) {
                alert('Please select all required fields');
                return;
            }

            var assignmentRef = database.ref('Assignments/' + date + '/subContractors/' + subContractorId);
            assignmentRef.set({
                siteId: siteId,
                present: true,
                timestamp: Date.now()
            })
            .then(() => {
                document.getElementById('subContractorSelect').value = '';
                updateCurrentAssignments();
                updateSubContractorSelect();
            })
            .catch(error => console.error("Error assigning subcontractor:", error));
        }

        function togglePresence(id, isWorker) {
            var date = document.getElementById('currentDate').value;
            var category = isWorker ? 'workers' : 'subContractors';
            var ref = database.ref('Assignments/' + date + '/' + category + '/' + id + '/present');
            ref.once('value', function(snapshot) {
                ref.set(!snapshot.val())
                .then(() => updateCurrentAssignments())
                .catch(error => console.error("Error updating presence:", error));
            });
        }

        function removeAssignment(id, isWorker) {
            var date = document.getElementById('currentDate').value;
            var category = isWorker ? 'workers' : 'subContractors';
            database.ref('Assignments/' + date + '/' + category + '/' + id).remove()
            .then(() => {
                updateCurrentAssignments();
                if (isWorker) {
                    updateWorkerSelect();
                } else {
                    updateSubContractorSelect();
                }
            })
            .catch(error => console.error("Error removing assignment:", error));
        }

        function updateCurrentAssignments() {
            var date = document.getElementById('currentDate').value;
            var siteId = document.getElementById('siteSelect').value;
            var div = document.getElementById('currentAssignments');

            if (!date || !siteId) {
                div.innerHTML = '';
                return;
            }

            var site = sites.find(function(s) { return s.id === siteId; });
            if (!site) return;

            var html = '<h3>Current Assignments for ' + site.siteName + ' on ' + new Date(date).toDateString() + '</h3>';

            // Workers Table
            html += '<h4>Workers</h4>' +
                '<table>' +
                '<tr>' +
                    '<th>Present</th>' +
                    '<th>Worker Name</th>' +
                    '<th>Type</th>' +
                    '<th>Contact</th>' +
                    '<th>Wage</th>' +
                    '<th>Time Added</th>' +
                    '<th>Actions</th>' +
                '</tr>';

            database.ref('Assignments/' + date + '/workers').orderByChild('timestamp').once('value', function(snapshot) {
                snapshot.forEach(function(childSnapshot) {
                    var assignment = childSnapshot.val();
                    if (assignment.siteId === siteId) {
                        var workerId = childSnapshot.key;
                        var worker = workers.find(function(w) { return w.id === workerId; });
                        if (worker) {
                            html += '<tr class="' + (assignment.present ? 'present' : 'absent') + '">' +
                                '<td>' +
                                    '<input type="checkbox" ' +
                                        (assignment.present ? 'checked' : '') + 
                                        ' onchange="togglePresence(\'' + worker.id + '\', true)">' +
                                '</td>' +
                                '<td>' + worker.workerName + '</td>' +
                                '<td>' + worker.workerType + '</td>' +
                                '<td>' + worker.contact + '</td>' +
                                '<td>' + formatCurrency(worker.dailyWage) + '</td>' +
                                '<td><span class="timestamp">' +
                                    new Date(assignment.timestamp).toLocaleTimeString() +
                                '</span></td>' +
                                '<td>' +
                                    '<button class="delete-btn" onclick="removeAssignment(\'' + worker.id + '\', true)">' +
                                        'Remove' +
                                    '</button>' +
                                '</td>' +
                            '</tr>';
                        }
                    }
                });

                html += '</table>';

                // Sub Contractors Table
                html += '<h4>Sub Contractors</h4>' +
                    '<table>' +
                    '<tr>' +
                        '<th>Present</th>' +
                        '<th>Type of Work</th>' +
                        '<th>Name</th>' +
                        '<th>Number of Workers</th>' +
                        '<th>Daily Rate</th>' +
                        '<th>Time Added</th>' +
                        '<th>Actions</th>' +
                    '</tr>';

                database.ref('Assignments/' + date + '/subContractors').orderByChild('timestamp').once('value', function(snapshot) {
                    snapshot.forEach(function(childSnapshot) {
                        var assignment = childSnapshot.val();
                        if (assignment.siteId === siteId) {
                            var scId = childSnapshot.key;
                            var sc = subContractors.find(function(s) { return s.id === scId; });
                            if (sc) {
                                html += '<tr class="' + (assignment.present ? 'present' : 'absent') + '">' +
                                    '<td>' +
                                        '<input type="checkbox" ' +
                                            (assignment.present ? 'checked' : '') + 
                                            ' onchange="togglePresence(\'' + sc.id + '\', false)">' +
                                    '</td>' +
                                    '<td>' + sc.typeOfWork + '</td>' +
                                    '<td>' + sc.contractorName + '</td>' +
                                    '<td>' + sc.numOfWorkers + '</td>' +
                                    '<td>' + formatCurrency(sc.dailyRate) + '</td>' +
                                    '<td><span class="timestamp">' +
                                        new Date(assignment.timestamp).toLocaleTimeString() +
                                    '</span></td>' +
                                    '<td>' +
                                        '<button class="delete-btn" onclick="removeAssignment(\'' + sc.id + '\', false)">' +
                                            'Remove' +
                                        '</button>' +
                                    '</td>' +
                                '</tr>';
                            }
                        }
                    });

                    html += '</table>';
                    div.innerHTML = html;
                });
            });
        }

        // Report Generation
        // (You can implement report generation functions here, integrating with Firebase as needed)

        // Helper Functions for Weekly Report
        function getStartDateOfWeek(year, week) {
            var simple = new Date(year, 0, 1 + (week - 1) * 7);
            var dow = simple.getDay();
            var ISOweekStart = simple;
            if (dow <= 4)
                ISOweekStart.setDate(simple.getDate() - simple.getDay() + 1);
            else
                ISOweekStart.setDate(simple.getDate() + 8 - simple.getDay());
            return ISOweekStart;
        }

        function getDatesOfWeek(startDate) {
            var dates = [];
            for (var i = 0; i < 7; i++) {
                var date = new Date(startDate);
                date.setDate(startDate.getDate() + i);
                dates.push(date);
            }
            return dates;
        }
    </script>
</body>
</html>
