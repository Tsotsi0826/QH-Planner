<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Construction Labor Management System</title>
    <style>
        /* CSS Styles */
        body { 
            font-family: Arial, sans-serif; 
            padding: 20px; 
            max-width: 1200px; 
            margin: 0 auto;
            background-color: #f5f5f5;
        }

        /* Updated styles for the top navigation */
        .top-nav {
            display: flex;
            justify-content: flex-start;
            margin-bottom: 10px;
        }

        .home-btn {
            display: flex;
            align-items: center;
            padding: 8px 16px;
            color: #2196F3;
            background-color: transparent;
            text-decoration: none;
            border-radius: 4px;
            font-size: 24px;
            transition: background-color 0.2s;
        }

        .home-btn:hover {
            background-color: #e0e0e0;
        }

        .home-btn span {
            font-size: 24px;
        }

        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .section-header {
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Buttons */
        button { 
            padding: 8px 16px; 
            color: white; 
            border: none; 
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }

        .primary-btn {
            background-color: #4CAF50;
        }

        .primary-btn:hover {
            background-color: #45a049;
        }

        .edit-btn {
            background-color: #2196F3;
            padding: 4px 12px;
        }

        .edit-btn:hover {
            background-color: #1976D2;
        }

        .delete-btn {
            background-color: #f44336;
            padding: 4px 12px;
        }

        .delete-btn:hover {
            background-color: #d32f2f;
        }

        .add-btn {
            background-color: #ff9800;
            padding: 8px 16px;
        }

        .add-btn:hover {
            background-color: #f57c00;
        }

        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
            background: white;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }

        th {
            background-color: #f5f5f5;
            font-weight: bold;
        }

        tr:hover {
            background-color: #f9f9f9;
        }

        /* Status Classes */
        .present { 
            background-color: #e8f5e9; 
        }

        .present:hover { 
            background-color: #c8e6c9; 
        }

        .absent { 
            background-color: #ffebee; 
        }

        .absent:hover { 
            background-color: #ffcdd2; 
        }

        /* Form Controls */
        .controls-group {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .control-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        select, input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            min-width: 200px;
        }

        select:disabled {
            background-color: #f5f5f5;
            cursor: not-allowed;
        }

        /* Assignment Section */
        .assignment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .timestamp {
            color: #666;
            font-size: 0.9em;
        }

        /* Reports Section */
        .reports-container {
            margin-top: 20px;
            padding: 15px;
            border-top: 1px solid #ddd;
        }

        .total-row {
            font-weight: bold;
            background-color: #f5f5f5;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .controls-group {
                flex-direction: column;
                align-items: stretch;
            }

            select, input {
                width: 100%;
                min-width: unset;
            }

            table {
                display: block;
                overflow-x: auto;
            }

            /* Adjust top navigation for mobile */
            .top-nav {
                justify-content: center;
            }
        }
    </style>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <!-- SheetJS Library for Excel Export -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
    <!-- Top Navigation with Home Icon -->
    <div class="top-nav">
        <a href="index.html" class="home-btn" aria-label="Home">
            <span>üè†</span>
        </a>
    </div>

    <h1>Construction Labor Management System</h1>

    <!-- Setup Section -->
    <div class="container">
        <div class="section-header">
            <h2>Initial Setup</h2>
            <div>
                <button class="primary-btn" onclick="addSite()">Add Site</button>
                <button class="primary-btn" onclick="addWorker()">Add Worker</button>
                <button class="primary-btn" onclick="addSubContractor()">Add Sub Contractor</button>
            </div>
        </div>

        <!-- Sites Table -->
        <h3>Construction Sites</h3>
        <table>
            <thead>
                <tr>
                    <th>Site Name</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="sitesList"></tbody>
        </table>

        <!-- Workers Table -->
        <h3>Workers</h3>
        <table>
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Type</th>
                    <th>Contact</th>
                    <th>Daily Wage</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="workersList"></tbody>
        </table>

        <!-- Sub Contractors Table -->
        <h3>Sub Contractors</h3>
        <table>
            <thead>
                <tr>
                    <th>Type of Work</th>
                    <th>Name</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="subContractorsList"></tbody>
        </table>
    </div>

    <!-- Daily Assignment Section -->
    <div class="container">
        <div class="section-header">
            <h2>Daily Labor Assignment</h2>
        </div>

        <div class="controls-group">
            <div class="control-item">
                <label>1. Select Date:</label>
                <input type="date" id="currentDate" onchange="handleDateChange()">
            </div>
            <div class="control-item">
                <label>2. Select Site:</label>
                <select id="siteSelect" onchange="handleSiteChange()" disabled>
                    <option value="">Choose a site...</option>
                </select>
            </div>
            <div class="control-item">
                <label>3. Select Worker:</label>
                <select id="workerSelect" disabled>
                    <option value="">Choose a worker...</option>
                </select>
            </div>
            <button id="addWorkerBtn" class="add-btn" onclick="assignSelectedWorker()" disabled>
                Add Worker
            </button>
            <div class="control-item">
                <label>4. Select Sub Contractor:</label>
                <select id="subContractorSelect" disabled>
                    <option value="">Choose a sub contractor...</option>
                </select>
            </div>
            <button id="addSubContractorBtn" class="add-btn" onclick="assignSelectedSubContractor()" disabled>
                Add Sub Contractor
            </button>
        </div>

        <div id="currentAssignments"></div>
    </div>

    <!-- Reports Section -->
    <div class="container">
        <div class="section-header">
            <h2>Reports</h2>
        </div>

        <div class="controls-group">
            <div class="control-item">
                <label>Select Site:</label>
                <select id="reportSiteSelect">
                    <option value="">All Sites</option>
                </select>
            </div>
            <div class="control-item">
                <label>Select Date:</label>
                <input type="date" id="reportDateSelect">
            </div>
            <div class="control-item">
                <label>Select Week:</label>
                <input type="week" id="weekSelect">
            </div>
            <button class="primary-btn" onclick="showDailyReport()">Daily Report</button>
            <button class="primary-btn" onclick="showWeeklyReport()">Weekly Report</button>
        </div>

        <div id="reportArea"></div>
    </div>

    <!-- JavaScript Code -->
    <script>
         // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD82WxYqaYASCiTmcBd7nHHZMTsAJSZkIc",
            authDomain: "qh-planner.firebaseapp.com",
            databaseURL: "https://qh-planner-default-rtdb.firebaseio.com",
            projectId: "qh-planner",
            storageBucket: "qh-planner.appspot.com",
            messagingSenderId: "847763991357",
            appId: "1:847763991357:web:9dda19dfee4dac66a5f354"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Data Storage
        var sites = [];
        var workers = [];
        var subContractors = [];
        var dataLoaded = {
            sites: false,
            workers: false,
            subContractors: false
        };

        // Initialize the page
        function initializePage() {
            // Set the date inputs to today's date in the local time zone
            var today = new Date();
            today.setMinutes(today.getMinutes() - today.getTimezoneOffset());
            var todayDateStr = today.toISOString().split('T')[0];
            document.getElementById('currentDate').value = todayDateStr;
            document.getElementById('reportDateSelect').value = todayDateStr; // Initialize report date
            document.getElementById('weekSelect').value = getCurrentWeek();
            fetchSites();
            fetchWorkers();
            fetchSubContractors();
            handleDateChange(); // Ensure the page initializes correctly

            // Clear report area when date or week changes
            document.getElementById('reportDateSelect').addEventListener('change', function() {
                document.getElementById('reportArea').innerHTML = '';
            });

            document.getElementById('weekSelect').addEventListener('change', function() {
                document.getElementById('reportArea').innerHTML = '';
            });
        }

        // Call initializePage when the window loads
        window.onload = initializePage;

        // Helper Functions
        function getCurrentWeek() {
            var now = new Date();
            var onejan = new Date(now.getFullYear(), 0, 1);
            var week = Math.ceil((((now - onejan) / 86400000) + onejan.getDay() + 1) / 7);
            return now.getFullYear() + '-W' + week.toString().padStart(2, '0');
        }

        function formatCurrency(amount) {
            return 'R' + parseFloat(amount).toFixed(2);
        }

        // Fetch Sites from Firebase
        function fetchSites() {
            database.ref('Sites').on('value', function(snapshot) {
                sites = [];
                snapshot.forEach(function(childSnapshot) {
                    var site = childSnapshot.val();
                    site.id = childSnapshot.key;
                    sites.push(site);
                });
                dataLoaded.sites = true;
                updateSitesList();
                updateSiteSelect();
                updateReportSiteSelect(); // Update report site select
            });
        }

        // Update Report Site Select
        function updateReportSiteSelect() {
            var select = document.getElementById('reportSiteSelect');
            select.innerHTML = '<option value="">All Sites</option>' +
                sites.map(function(site) {
                    return '<option value="' + site.id + '">' + site.siteName + '</option>';
                }).join('');
        }

        // Site Management
        function addSite() {
            var siteName = prompt("Enter site name:");
            if (siteName && siteName.trim()) {
                var newSiteRef = database.ref('Sites').push();
                newSiteRef.set({
                    siteName: siteName.trim()
                })
                .then(() => alert("Site added successfully"))
                .catch(error => console.error("Error adding site:", error));
            }
        }

        function editSite(siteId) {
            var site = sites.find(function(s) { return s.id === siteId; });
            if (!site) return;

            var newName = prompt("Edit site name:", site.siteName);
            if (newName && newName.trim() && newName !== site.siteName) {
                database.ref('Sites/' + siteId).update({
                    siteName: newName.trim()
                })
                .then(() => alert("Site updated successfully"))
                .catch(error => console.error("Error updating site:", error));
            }
        }

        function deleteSite(siteId) {
            if (!confirm("Are you sure you want to delete this site?")) return;

            database.ref('Sites/' + siteId).remove()
            .then(() => {
                // Also remove related assignments
                database.ref('Assignments').once('value', function(snapshot) {
                    snapshot.forEach(function(dateSnapshot) {
                        var dateKey = dateSnapshot.key;
                        database.ref('Assignments/' + dateKey + '/workers').once('value', function(workerSnapshot) {
                            workerSnapshot.forEach(function(childSnapshot) {
                                if (childSnapshot.val().siteId === siteId) {
                                    database.ref('Assignments/' + dateKey + '/workers/' + childSnapshot.key).remove();
                                }
                            });
                        });
                        database.ref('Assignments/' + dateKey + '/subContractors').once('value', function(scSnapshot) {
                            scSnapshot.forEach(function(childSnapshot) {
                                if (childSnapshot.val().siteId === siteId) {
                                    database.ref('Assignments/' + dateKey + '/subContractors/' + childSnapshot.key).remove();
                                }
                            });
                        });
                    });
                });
                alert("Site deleted successfully");
            })
            .catch(error => console.error("Error deleting site:", error));
        }

        function updateSitesList() {
            var tbody = document.getElementById('sitesList');
            tbody.innerHTML = sites.map(function(site) {
                return '<tr>' +
                    '<td>' + site.siteName + '</td>' +
                    '<td>' +
                        '<button class="edit-btn" onclick="editSite(\'' + site.id + '\')">Edit</button>' +
                        '<button class="delete-btn" onclick="deleteSite(\'' + site.id + '\')">Delete</button>' +
                    '</td>' +
                '</tr>';
            }).join('');
        }

        function updateSiteSelect() {
            var select = document.getElementById('siteSelect');
            select.innerHTML = '<option value="">Choose a site...</option>' +
                sites.map(function(site) {
                    return '<option value="' + site.id + '">' + site.siteName + '</option>';
                }).join('');
        }

        // Fetch Workers from Firebase
        function fetchWorkers() {
            database.ref('Workers').on('value', function(snapshot) {
                workers = [];
                snapshot.forEach(function(childSnapshot) {
                    var worker = childSnapshot.val();
                    worker.id = childSnapshot.key;
                    workers.push(worker);
                });
                dataLoaded.workers = true;
                updateWorkersList();
                updateWorkerSelect();
            });
        }

        // Worker Management
        function addWorker() {
            const workerName = prompt("Enter worker name:");
            const workerType = prompt("Enter worker type (e.g., Permanent or Temporary):");
            const contact = prompt("Enter worker contact number:");
            const dailyWage = prompt("Enter daily wage in Rand (R):");

            if (workerName && workerType && contact && dailyWage) {
                const newWorkerRef = database.ref('Workers').push();

                newWorkerRef.set({
                    workerName: workerName.trim(),
                    workerType: workerType.trim(),
                    contact: contact.trim(),
                    dailyWage: parseFloat(dailyWage)
                })
                .then(() => alert("Worker added successfully"))
                .catch(error => {
                    console.error("Error adding worker:", error);
                    alert("Failed to add worker. Check console for details.");
                });
            } else {
                alert("Please provide all worker details to proceed.");
            }
        }

        function editWorker(workerId) {
            var worker = workers.find(function(w) { return w.id === workerId; });
            if (!worker) return;

            const workerName = prompt("Edit worker name:", worker.workerName);
            const workerType = prompt("Edit worker type (e.g., Permanent or Temporary):", worker.workerType);
            const contact = prompt("Edit worker contact number:", worker.contact);
            const dailyWage = prompt("Edit daily wage in Rand (R):", worker.dailyWage);

            if (workerName && workerType && contact && dailyWage) {
                database.ref('Workers/' + workerId).update({
                    workerName: workerName.trim(),
                    workerType: workerType.trim(),
                    contact: contact.trim(),
                    dailyWage: parseFloat(dailyWage)
                })
                .then(() => alert("Worker updated successfully"))
                .catch(error => {
                    console.error("Error updating worker:", error);
                    alert("Failed to update worker. Check console for details.");
                });
            } else {
                alert("Please provide all worker details to proceed.");
            }
        }

        function deleteWorker(workerId) {
            if (!confirm("Are you sure you want to delete this worker?")) return;

            database.ref('Workers/' + workerId).remove()
            .then(() => {
                // Also remove related assignments
                database.ref('Assignments').once('value', function(snapshot) {
                    snapshot.forEach(function(dateSnapshot) {
                        var dateKey = dateSnapshot.key;
                        var workersRef = database.ref('Assignments/' + dateKey + '/workers/' + workerId);
                        workersRef.remove();
                    });
                });
                alert("Worker deleted successfully");
            })
            .catch(error => {
                console.error("Error deleting worker:", error);
                alert("Failed to delete worker. Check console for details.");
            });
        }

        function updateWorkersList() {
            var tbody = document.getElementById('workersList');
            tbody.innerHTML = workers.map(function(worker) {
                return '<tr>' +
                    '<td>' + worker.workerName + '</td>' +
                    '<td>' + worker.workerType + '</td>' +
                    '<td>' + worker.contact + '</td>' +
                    '<td>' + formatCurrency(worker.dailyWage) + '</td>' +
                    '<td>' +
                        '<button class="edit-btn" onclick="editWorker(\'' + worker.id + '\')">Edit</button>' +
                        '<button class="delete-btn" onclick="deleteWorker(\'' + worker.id + '\')">Delete</button>' +
                    '</td>' +
                '</tr>';
            }).join('');
        }

        function updateWorkerSelect() {
            var select = document.getElementById('workerSelect');
            var date = document.getElementById('currentDate').value;
            var siteId = document.getElementById('siteSelect').value;

            if (!date || !siteId) {
                select.innerHTML = '<option value="">Choose a worker...</option>';
                return;
            }

            // Fetch assigned workers for this date and site
            database.ref('Assignments/' + date + '/workers').once('value', function(snapshot) {
                var assignedWorkerIds = [];
                snapshot.forEach(function(childSnapshot) {
                    var assignment = childSnapshot.val();
                    if (assignment.siteId === siteId) {
                        assignedWorkerIds.push(childSnapshot.key);
                    }
                });

                var availableWorkers = workers.filter(function(w) { return assignedWorkerIds.indexOf(w.id) === -1; });
                select.innerHTML = '<option value="">Choose a worker...</option>' +
                    availableWorkers.map(function(worker) {
                        return '<option value="' + worker.id + '">' +
                            worker.workerName + ' (' + worker.workerType + ')' +
                        '</option>';
                    }).join('');
            });
        }

        // Fetch Sub Contractors from Firebase
        function fetchSubContractors() {
            database.ref('Subcontractors').on('value', function(snapshot) {
                subContractors = [];
                snapshot.forEach(function(childSnapshot) {
                    var sc = childSnapshot.val();
                    sc.id = childSnapshot.key;
                    subContractors.push(sc);
                });
                dataLoaded.subContractors = true;
                updateSubContractorsList();
                updateSubContractorSelect();
            });
        }

        // Sub Contractor Management
        function addSubContractor() {
            const typeOfWork = prompt("Enter type of work (e.g., Brickwork, Plaster, Carpentry):");
            const contractorName = prompt("Enter subcontractor name:");

            if (typeOfWork && contractorName) {
                const newSubcontractorRef = database.ref('Subcontractors').push();
                newSubcontractorRef.set({
                    typeOfWork: typeOfWork.trim(),
                    contractorName: contractorName.trim()
                })
                .then(() => alert("Subcontractor added successfully"))
                .catch(error => console.error("Error adding subcontractor:", error));
            } else {
                alert("Please provide all subcontractor details to proceed.");
            }
        }

        function editSubContractor(subContractorId) {
            var sc = subContractors.find(function(s) { return s.id === subContractorId; });
            if (!sc) return;

            const typeOfWork = prompt("Edit type of work (e.g., Brickwork, Plaster, Carpentry):", sc.typeOfWork);
            const contractorName = prompt("Edit subcontractor name:", sc.contractorName);

            if (typeOfWork && contractorName) {
                database.ref('Subcontractors/' + subContractorId).update({
                    typeOfWork: typeOfWork.trim(),
                    contractorName: contractorName.trim()
                })
                .then(() => alert("Subcontractor updated successfully"))
                .catch(error => console.error("Error updating subcontractor:", error));
            } else {
                alert("Please provide all subcontractor details to proceed.");
            }
        }

        function deleteSubContractor(subContractorId) {
            if (!confirm("Are you sure you want to delete this subcontractor?")) return;

            database.ref('Subcontractors/' + subContractorId).remove()
            .then(() => {
                // Also remove related assignments
                database.ref('Assignments').once('value', function(snapshot) {
                    snapshot.forEach(function(dateSnapshot) {
                        var dateKey = dateSnapshot.key;
                        var scRef = database.ref('Assignments/' + dateKey + '/subContractors/' + subContractorId);
                        scRef.remove();
                    });
                });
                alert("Subcontractor deleted successfully");
            })
            .catch(error => console.error("Error deleting subcontractor:", error));
        }

        function updateSubContractorsList() {
            var tbody = document.getElementById('subContractorsList');
            tbody.innerHTML = subContractors.map(function(sc) {
                return '<tr>' +
                    '<td>' + sc.typeOfWork + '</td>' +
                    '<td>' + sc.contractorName + '</td>' +
                    '<td>' +
                        '<button class="edit-btn" onclick="editSubContractor(\'' + sc.id + '\')">Edit</button>' +
                        '<button class="delete-btn" onclick="deleteSubContractor(\'' + sc.id + '\')">Delete</button>' +
                    '</td>' +
                '</tr>';
            }).join('');
        }

        function updateSubContractorSelect() {
            var select = document.getElementById('subContractorSelect');
            var date = document.getElementById('currentDate').value;
            var siteId = document.getElementById('siteSelect').value;

            if (!date || !siteId) {
                select.innerHTML = '<option value="">Choose a sub contractor...</option>';
                return;
            }

            // Fetch assigned subcontractors for this date and site
            database.ref('Assignments/' + date + '/subContractors').once('value', function(snapshot) {
                var assignedSubContractorIds = [];
                snapshot.forEach(function(childSnapshot) {
                    var assignment = childSnapshot.val();
                    if (assignment.siteId === siteId) {
                        assignedSubContractorIds.push(childSnapshot.key);
                    }
                });

                var availableSubContractors = subContractors.filter(function(s) { return assignedSubContractorIds.indexOf(s.id) === -1; });
                select.innerHTML = '<option value="">Choose a sub contractor...</option>' +
                    availableSubContractors.map(function(sc) {
                        return '<option value="' + sc.id + '">' +
                            sc.contractorName + ' (' + sc.typeOfWork + ')' +
                        '</option>';
                    }).join('');
            });
        }

        // Assignment Management
        function handleDateChange() {
            var siteSelect = document.getElementById('siteSelect');
            var workerSelect = document.getElementById('workerSelect');
            var addWorkerBtn = document.getElementById('addWorkerBtn');
            var subContractorSelect = document.getElementById('subContractorSelect');
            var addSubContractorBtn = document.getElementById('addSubContractorBtn');

            siteSelect.disabled = false;
            workerSelect.disabled = true;
            addWorkerBtn.disabled = true;
            subContractorSelect.disabled = true;
            addSubContractorBtn.disabled = true;

            updateCurrentAssignments();
            updateSiteSelect(); // Ensure the site select is updated
        }

        function handleSiteChange() {
            var workerSelect = document.getElementById('workerSelect');
            var addWorkerBtn = document.getElementById('addWorkerBtn');
            var subContractorSelect = document.getElementById('subContractorSelect');
            var addSubContractorBtn = document.getElementById('addSubContractorBtn');

            workerSelect.disabled = false;
            addWorkerBtn.disabled = false;
            subContractorSelect.disabled = false;
            addSubContractorBtn.disabled = false;

            updateWorkerSelect();
            updateSubContractorSelect();
            updateCurrentAssignments();
        }

        function assignSelectedWorker() {
            var date = document.getElementById('currentDate').value;
            var siteId = document.getElementById('siteSelect').value;
            var workerId = document.getElementById('workerSelect').value;

            if (!date || !siteId || !workerId) {
                alert('Please select all required fields');
                return;
            }

            // Prompt for IOU amount
            var iouAmount = prompt("Enter IOU amount for this worker in Rand (R):", "0");
            iouAmount = parseFloat(iouAmount);
            if (isNaN(iouAmount) || iouAmount < 0) {
                alert("Invalid IOU amount.");
                return;
            }

            var assignmentRef = database.ref('Assignments/' + date + '/workers/' + workerId);
            assignmentRef.set({
                siteId: siteId,
                present: true,
                timestamp: Date.now(),
                iou: iouAmount
            })
            .then(() => {
                document.getElementById('workerSelect').value = '';
                updateCurrentAssignments();
                updateWorkerSelect();
            })
            .catch(error => console.error("Error assigning worker:", error));
        }

        function assignSelectedSubContractor() {
            var date = document.getElementById('currentDate').value;
            var siteId = document.getElementById('siteSelect').value;
            var subContractorId = document.getElementById('subContractorSelect').value;

            if (!date || !siteId || !subContractorId) {
                alert('Please select all required fields');
                return;
            }

            // Prompt for number of Senior Staff and their wage
            var numSeniorStaff = prompt("Enter number of Senior Staff:");
            numSeniorStaff = parseInt(numSeniorStaff);
            if (isNaN(numSeniorStaff) || numSeniorStaff < 0) {
                alert("Invalid number of Senior Staff.");
                return;
            }

            var seniorStaffWage = prompt("Enter wage per Senior Staff in Rand (R):");
            seniorStaffWage = parseFloat(seniorStaffWage);
            if (isNaN(seniorStaffWage) || seniorStaffWage < 0) {
                alert("Invalid Senior Staff wage.");
                return;
            }

            // Prompt for number of Labour Staff and their wage
            var numLabour = prompt("Enter number of Labour Staff:");
            numLabour = parseInt(numLabour);
            if (isNaN(numLabour) || numLabour < 0) {
                alert("Invalid number of Labour Staff.");
                return;
            }

            var labourStaffWage = prompt("Enter wage per Labour Staff in Rand (R):");
            labourStaffWage = parseFloat(labourStaffWage);
            if (isNaN(labourStaffWage) || labourStaffWage < 0) {
                alert("Invalid Labour Staff wage.");
                return;
            }

            // Prompt for IOU amount
            var iouAmount = prompt("Enter IOU amount for this subcontractor in Rand (R):", "0");
            iouAmount = parseFloat(iouAmount);
            if (isNaN(iouAmount) || iouAmount < 0) {
                alert("Invalid IOU amount.");
                return;
            }

            var assignmentRef = database.ref('Assignments/' + date + '/subContractors/' + subContractorId);
            assignmentRef.set({
                siteId: siteId,
                present: true,
                numSeniorStaff: numSeniorStaff,
                seniorStaffWage: seniorStaffWage,
                numLabour: numLabour,
                labourStaffWage: labourStaffWage,
                iou: iouAmount,
                timestamp: Date.now()
            })
            .then(() => {
                document.getElementById('subContractorSelect').value = '';
                updateCurrentAssignments();
                updateSubContractorSelect();
            })
            .catch(error => console.error("Error assigning subcontractor:", error));
        }

        function togglePresence(id, isWorker) {
            var date = document.getElementById('currentDate').value;
            var category = isWorker ? 'workers' : 'subContractors';
            var ref = database.ref('Assignments/' + date + '/' + category + '/' + id + '/present');
            ref.once('value', function(snapshot) {
                ref.set(!snapshot.val())
                .then(() => updateCurrentAssignments())
                .catch(error => console.error("Error updating presence:", error));
            });
        }

        function removeAssignment(id, isWorker) {
            var date = document.getElementById('currentDate').value;
            var category = isWorker ? 'workers' : 'subContractors';
            database.ref('Assignments/' + date + '/' + category + '/' + id).remove()
            .then(() => {
                updateCurrentAssignments();
                if (isWorker) {
                    updateWorkerSelect();
                } else {
                    updateSubContractorSelect();
                }
            })
            .catch(error => console.error("Error removing assignment:", error));
        }

        function updateCurrentAssignments() {
            var date = document.getElementById('currentDate').value;
            var siteId = document.getElementById('siteSelect').value;
            var div = document.getElementById('currentAssignments');

            if (!date || !siteId) {
                div.innerHTML = '';
                return;
            }

            var site = sites.find(function(s) { return s.id === siteId; });
            if (!site) return;

            var html = '<h3>Current Assignments for ' + site.siteName + ' on ' + new Date(date).toDateString() + '</h3>';

            // Workers Table
            html += '<h4>Workers</h4>' +
                '<table>' +
                '<tr>' +
                    '<th>Present</th>' +
                    '<th>Worker Name</th>' +
                    '<th>Type</th>' +
                    '<th>Contact</th>' +
                    '<th>Wage</th>' +
                    '<th>IOU</th>' +
                    '<th>Time Added</th>' +
                    '<th>Actions</th>' +
                '</tr>';

            database.ref('Assignments/' + date + '/workers').orderByChild('timestamp').once('value', function(snapshot) {
                var hasWorkers = false;
                snapshot.forEach(function(childSnapshot) {
                    var assignment = childSnapshot.val();
                    if (assignment.siteId === siteId) {
                        hasWorkers = true;
                        var workerId = childSnapshot.key;
                        var worker = workers.find(function(w) { return w.id === workerId; });
                        if (worker) {
                            html += '<tr class="' + (assignment.present ? 'present' : 'absent') + '">' +
                                '<td>' +
                                    '<input type="checkbox" ' +
                                        (assignment.present ? 'checked' : '') + 
                                        ' onchange="togglePresence(\'' + worker.id + '\', true)">' +
                                '</td>' +
                                '<td>' + worker.workerName + '</td>' +
                                '<td>' + worker.workerType + '</td>' +
                                '<td>' + worker.contact + '</td>' +
                                '<td>' + formatCurrency(worker.dailyWage) + '</td>' +
                                '<td>' + formatCurrency(assignment.iou || 0) + '</td>' +
                                '<td><span class="timestamp">' +
                                    new Date(assignment.timestamp).toLocaleTimeString() +
                                '</span></td>' +
                                '<td>' +
                                    '<button class="edit-btn" onclick="editAssignment(\'' + date + '\', \'' + worker.id + '\', true)">Edit</button>' +
                                    '<button class="delete-btn" onclick="removeAssignment(\'' + worker.id + '\', true)">' +
                                        'Remove' +
                                    '</button>' +
                                '</td>' +
                            '</tr>';
                        }
                    }
                });

                html += '</table>';

                // Sub Contractors Table
                html += '<h4>Sub Contractors</h4>' +
                    '<table>' +
                    '<tr>' +
                        '<th>Present</th>' +
                        '<th>Type of Work</th>' +
                        '<th>Name</th>' +
                        '<th>Senior Staff</th>' +
                        '<th>Labour Staff</th>' +
                        '<th>Total Cost</th>' +
                        '<th>IOU</th>' +
                        '<th>Time Added</th>' +
                        '<th>Actions</th>' +
                    '</tr>';

                database.ref('Assignments/' + date + '/subContractors').orderByChild('timestamp').once('value', function(snapshot) {
                    var hasSubContractors = false;
                    snapshot.forEach(function(childSnapshot) {
                        var assignment = childSnapshot.val();
                        if (assignment.siteId === siteId) {
                            hasSubContractors = true;
                            var scId = childSnapshot.key;
                            var sc = subContractors.find(function(s) { return s.id === scId; });
                            if (sc) {
                                var totalCost = (assignment.numSeniorStaff * assignment.seniorStaffWage) + 
                                                (assignment.numLabour * assignment.labourStaffWage);

                                html += '<tr class="' + (assignment.present ? 'present' : 'absent') + '">' +
                                    '<td>' +
                                        '<input type="checkbox" ' +
                                            (assignment.present ? 'checked' : '') + 
                                            ' onchange="togglePresence(\'' + sc.id + '\', false)">' +
                                    '</td>' +
                                    '<td>' + sc.typeOfWork + '</td>' +
                                    '<td>' + sc.contractorName + '</td>' +
                                    '<td>' +
                                        assignment.numSeniorStaff + ' x ' + formatCurrency(assignment.seniorStaffWage) +
                                    '</td>' +
                                    '<td>' +
                                        assignment.numLabour + ' x ' + formatCurrency(assignment.labourStaffWage) +
                                    '</td>' +
                                    '<td>' + formatCurrency(totalCost) + '</td>' +
                                    '<td>' + formatCurrency(assignment.iou || 0) + '</td>' +
                                    '<td><span class="timestamp">' +
                                        new Date(assignment.timestamp).toLocaleTimeString() +
                                    '</span></td>' +
                                    '<td>' +
                                        '<button class="edit-btn" onclick="editAssignment(\'' + date + '\', \'' + sc.id + '\', false)">Edit</button>' +
                                        '<button class="delete-btn" onclick="removeAssignment(\'' + sc.id + '\', false)">' +
                                            'Remove' +
                                        '</button>' +
                                    '</td>' +
                                '</tr>';
                            }
                        }
                    });

                    html += '</table>';

                    div.innerHTML = html;
                });
            });
        }

        // Function to edit assignments from the report or current assignments
        function editAssignment(date, id, isWorker) {
            var category = isWorker ? 'workers' : 'subContractors';
            var assignmentRef = database.ref('Assignments/' + date + '/' + category + '/' + id);

            assignmentRef.once('value').then(function(snapshot) {
                var assignment = snapshot.val();
                if (!assignment) {
                    alert("Assignment not found.");
                    return;
                }

                if (isWorker) {
                    // Edit worker assignment
                    var present = confirm("Is the worker present? Click 'OK' for Yes, 'Cancel' for No.");
                    var iouAmount = prompt("Enter IOU amount for this worker in Rand (R):", assignment.iou || "0");
                    iouAmount = parseFloat(iouAmount);
                    if (isNaN(iouAmount) || iouAmount < 0) {
                        alert("Invalid IOU amount.");
                        return;
                    }

                    assignmentRef.update({
                        present: present,
                        iou: iouAmount
                    })
                    .then(() => {
                        alert("Assignment updated successfully.");
                        updateCurrentAssignments();
                        updateWorkerSelect();
                    })
                    .catch(error => console.error("Error updating assignment:", error));

                } else {
                    // Edit subcontractor assignment
                    var present = confirm("Is the subcontractor present? Click 'OK' for Yes, 'Cancel' for No.");
                    var numSeniorStaff = prompt("Enter number of Senior Staff:", assignment.numSeniorStaff);
                    numSeniorStaff = parseInt(numSeniorStaff);
                    if (isNaN(numSeniorStaff) || numSeniorStaff < 0) {
                        alert("Invalid number of Senior Staff.");
                        return;
                    }

                    var seniorStaffWage = prompt("Enter wage per Senior Staff in Rand (R):", assignment.seniorStaffWage);
                    seniorStaffWage = parseFloat(seniorStaffWage);
                    if (isNaN(seniorStaffWage) || seniorStaffWage < 0) {
                        alert("Invalid Senior Staff wage.");
                        return;
                    }

                    var numLabour = prompt("Enter number of Labour Staff:", assignment.numLabour);
                    numLabour = parseInt(numLabour);
                    if (isNaN(numLabour) || numLabour < 0) {
                        alert("Invalid number of Labour Staff.");
                        return;
                    }

                    var labourStaffWage = prompt("Enter wage per Labour Staff in Rand (R):", assignment.labourStaffWage);
                    labourStaffWage = parseFloat(labourStaffWage);
                    if (isNaN(labourStaffWage) || labourStaffWage < 0) {
                        alert("Invalid Labour Staff wage.");
                        return;
                    }

                    var iouAmount = prompt("Enter IOU amount for this subcontractor in Rand (R):", assignment.iou || "0");
                    iouAmount = parseFloat(iouAmount);
                    if (isNaN(iouAmount) || iouAmount < 0) {
                        alert("Invalid IOU amount.");
                        return;
                    }

                    assignmentRef.update({
                        present: present,
                        numSeniorStaff: numSeniorStaff,
                        seniorStaffWage: seniorStaffWage,
                        numLabour: numLabour,
                        labourStaffWage: labourStaffWage,
                        iou: iouAmount
                    })
                    .then(() => {
                        alert("Assignment updated successfully.");
                        updateCurrentAssignments();
                        updateSubContractorSelect();
                    })
                    .catch(error => console.error("Error updating assignment:", error));
                }
            });
        }

        // Report Generation
        function showDailyReport() {
            var date = document.getElementById('reportDateSelect').value; // Use report date input
            var siteId = document.getElementById('reportSiteSelect').value;
            if (!date) {
                alert("Please select a date.");
                return;
            }

            var reportArea = document.getElementById('reportArea');
            reportArea.innerHTML = '<h3>Daily Report for ' + new Date(date).toDateString() + '</h3>';

            // Ensure all data is loaded before generating the report
            if (dataLoaded.sites && dataLoaded.workers && dataLoaded.subContractors) {
                generateReport([date], reportArea, siteId);
            } else {
                // Wait until data is loaded
                var checkDataLoaded = setInterval(function() {
                    if (dataLoaded.sites && dataLoaded.workers && dataLoaded.subContractors) {
                        clearInterval(checkDataLoaded);
                        generateReport([date], reportArea, siteId);
                    }
                }, 100);
            }
        }

        function showWeeklyReport() {
            var weekInput = document.getElementById('weekSelect').value;
            var siteId = document.getElementById('reportSiteSelect').value;
            if (!weekInput) {
                alert("Please select a week.");
                return;
            }

            var [year, week] = weekInput.split('-W');
            var startDate = getStartDateOfWeek(parseInt(year), parseInt(week));
            var datesOfWeek = getDatesOfWeek(startDate);

            var reportArea = document.getElementById('reportArea');
            reportArea.innerHTML = '<h3>Weekly Report for Week ' + week + ', ' + year + '</h3>';

            var dateStrings = datesOfWeek.map(date => {
                date.setMinutes(date.getMinutes() - date.getTimezoneOffset());
                return date.toISOString().split('T')[0];
            });

            // Ensure all data is loaded before generating the report
            if (dataLoaded.sites && dataLoaded.workers && dataLoaded.subContractors) {
                generateReport(dateStrings, reportArea, siteId);
            } else {
                // Wait until data is loaded
                var checkDataLoaded = setInterval(function() {
                    if (dataLoaded.sites && dataLoaded.workers && dataLoaded.subContractors) {
                        clearInterval(checkDataLoaded);
                        generateReport(dateStrings, reportArea, siteId);
                    }
                }, 100);
            }
        }

        function generateReport(dates, reportArea, filterSiteId) {
            var totalWorkerWages = 0;
            var totalWorkerIOU = 0;
            var totalSubContractorCost = 0;
            var totalSubContractorIOU = 0;

            var reportHtml = '';

            // Workers Report
            reportHtml += '<h4>Workers</h4>' +
                '<table id="workersReportTable">' +
                '<tr>' +
                    '<th>Worker Name</th>' +
                    '<th>Site</th>' +
                    '<th>Total Days Present</th>' +
                    '<th>Total Wages</th>' +
                    '<th>IOU</th>' +
                    '<th>Net Payable</th>' +
                    '<th>Actions</th>' +
                '</tr>';

            var workerData = {};

            // Fetch assignments for each date
            var promises = dates.map(date => {
                return database.ref('Assignments/' + date + '/workers').once('value').then(snapshot => {
                    snapshot.forEach(function(childSnapshot) {
                        var assignment = childSnapshot.val();
                        if (assignment.present && (!filterSiteId || assignment.siteId === filterSiteId)) {
                            var workerId = childSnapshot.key;
                            var worker = workers.find(w => w.id === workerId);
                            var site = sites.find(s => s.id === assignment.siteId);
                            var siteName = site ? site.siteName : 'Unknown Site';
                            if (worker) {
                                var key = workerId + '_' + assignment.siteId;
                                if (!workerData[key]) {
                                    workerData[key] = {
                                        workerId: workerId,
                                        date: date,
                                        workerName: worker.workerName,
                                        siteName: siteName,
                                        dailyWage: worker.dailyWage,
                                        daysPresent: 0,
                                        totalWage: 0,
                                        totalIOU: 0
                                    };
                                }
                                workerData[key].daysPresent += 1;
                                workerData[key].totalWage += worker.dailyWage;
                                workerData[key].totalIOU += assignment.iou || 0;
                            }
                        }
                    });
                });
            });

            var scPromises = dates.map(date => {
                return database.ref('Assignments/' + date + '/subContractors').once('value').then(snapshot => {
                    // Subcontractors data will be processed later
                    return { date: date, snapshot: snapshot };
                });
            });

            // Wait for both workers and subcontractors data to be fetched
            Promise.all(promises.concat(scPromises)).then(results => {
                // Process worker data
                for (var key in workerData) {
                    var data = workerData[key];
                    var netPayable = data.totalWage - data.totalIOU;
                    totalWorkerWages += data.totalWage;
                    totalWorkerIOU += data.totalIOU;

                    reportHtml += '<tr>' +
                        '<td>' + data.workerName + '</td>' +
                        '<td>' + data.siteName + '</td>' +
                        '<td>' + data.daysPresent + '</td>' +
                        '<td>' + formatCurrency(data.totalWage) + '</td>' +
                        '<td>' + formatCurrency(data.totalIOU) + '</td>' +
                        '<td>' + formatCurrency(netPayable) + '</td>' +
                        '<td>' +
                            '<button class="edit-btn" onclick="editReportAssignment(\'' + data.date + '\', \'' + data.workerId + '\', true)">Edit</button>' +
                            '<button class="delete-btn" onclick="deleteReportAssignment(\'' + data.date + '\', \'' + data.workerId + '\', true)">Delete</button>' +
                        '</td>' +
                    '</tr>';
                }

                reportHtml += '<tr class="total-row">' +
                    '<td colspan="3">Total</td>' +
                    '<td>' + formatCurrency(totalWorkerWages) + '</td>' +
                    '<td>' + formatCurrency(totalWorkerIOU) + '</td>' +
                    '<td>' + formatCurrency(totalWorkerWages - totalWorkerIOU) + '</td>' +
                    '<td></td>' +
                '</tr>';

                reportHtml += '</table>';

                // Subcontractors Report
                reportHtml += '<h4>Sub Contractors</h4>' +
                    '<table id="subContractorsReportTable">' +
                    '<tr>' +
                        '<th>Contractor Name</th>' +
                        '<th>Type of Work</th>' +
                        '<th>Site</th>' +
                        '<th>Total Cost</th>' +
                        '<th>IOU</th>' +
                        '<th>Net Payable</th>' +
                        '<th>Actions</th>' +
                    '</tr>';

                var subContractorData = {};

                // Process subcontractor data
                results.slice(promises.length).forEach(result => {
                    var date = result.date;
                    var snapshot = result.snapshot;
                    snapshot.forEach(function(childSnapshot) {
                        var assignment = childSnapshot.val();
                        if (assignment.present && (!filterSiteId || assignment.siteId === filterSiteId)) {
                            var scId = childSnapshot.key;
                            var sc = subContractors.find(s => s.id === scId);
                            var site = sites.find(s => s.id === assignment.siteId);
                            var siteName = site ? site.siteName : 'Unknown Site';
                            if (sc) {
                                var totalCost = (assignment.numSeniorStaff * assignment.seniorStaffWage) +
                                                (assignment.numLabour * assignment.labourStaffWage);

                                var key = scId + '_' + assignment.siteId;
                                if (!subContractorData[key]) {
                                    subContractorData[key] = {
                                        scId: scId,
                                        date: date,
                                        contractorName: sc.contractorName,
                                        typeOfWork: sc.typeOfWork,
                                        siteName: siteName,
                                        totalCost: 0,
                                        totalIOU: 0
                                    };
                                }
                                subContractorData[key].totalCost += totalCost;
                                subContractorData[key].totalIOU += assignment.iou || 0;
                                totalSubContractorCost += totalCost;
                                totalSubContractorIOU += assignment.iou || 0;
                            }
                        }
                    });
                });

                for (var key in subContractorData) {
                    var data = subContractorData[key];
                    var netPayable = data.totalCost - data.totalIOU;
                    reportHtml += '<tr>' +
                        '<td>' + data.contractorName + '</td>' +
                        '<td>' + data.typeOfWork + '</td>' +
                        '<td>' + data.siteName + '</td>' +
                        '<td>' + formatCurrency(data.totalCost) + '</td>' +
                        '<td>' + formatCurrency(data.totalIOU) + '</td>' +
                        '<td>' + formatCurrency(netPayable) + '</td>' +
                        '<td>' +
                            '<button class="edit-btn" onclick="editReportAssignment(\'' + data.date + '\', \'' + data.scId + '\', false)">Edit</button>' +
                            '<button class="delete-btn" onclick="deleteReportAssignment(\'' + data.date + '\', \'' + data.scId + '\', false)">Delete</button>' +
                        '</td>' +
                    '</tr>';
                }

                reportHtml += '<tr class="total-row">' +
                    '<td colspan="3">Total</td>' +
                    '<td>' + formatCurrency(totalSubContractorCost) + '</td>' +
                    '<td>' + formatCurrency(totalSubContractorIOU) + '</td>' +
                    '<td>' + formatCurrency(totalSubContractorCost - totalSubContractorIOU) + '</td>' +
                    '<td></td>' +
                '</tr>';

                reportHtml += '</table>';

                // Add Export to Excel Button
                reportHtml += '<button class="primary-btn" onclick="exportReportToExcel()">Export Report to Excel</button>';

                // Display the report
                reportArea.innerHTML += reportHtml;
            });
        }

        // Functions to edit and delete assignments from the report
        function editReportAssignment(date, id, isWorker) {
            editAssignment(date, id, isWorker);
        }

        function deleteReportAssignment(date, id, isWorker) {
            if (!confirm("Are you sure you want to delete this assignment?")) return;

            var category = isWorker ? 'workers' : 'subContractors';
            database.ref('Assignments/' + date + '/' + category + '/' + id).remove()
            .then(() => {
                alert("Assignment deleted successfully.");
                showDailyReport(); // Refresh the report
            })
            .catch(error => console.error("Error deleting assignment:", error));
        }

        // Updated Export Report to Excel Function
        function exportReportToExcel() {
            // Create a new workbook
            var wb = XLSX.utils.book_new();

            // Get the reportArea element
            var reportArea = document.getElementById('reportArea');

            // Workers Data
            var workersSheetData = [
                ['Worker Name', 'Site', 'Total Days Present', 'Total Wages', 'IOU', 'Net Payable']
            ];

            var workerRows = reportArea.querySelectorAll('#workersReportTable tr');
            for (var i = 1; i < workerRows.length; i++) { // Start after header row
                var cells = workerRows[i].querySelectorAll('td');
                // Skip total row
                if (cells[0].innerText.trim() === 'Total') {
                    continue;
                }
                workersSheetData.push([
                    cells[0].innerText, // Worker Name
                    cells[1].innerText, // Site
                    cells[2].innerText, // Total Days Present
                    cells[3].innerText.replace('R', ''), // Total Wages
                    cells[4].innerText.replace('R', ''), // IOU
                    cells[5].innerText.replace('R', '')  // Net Payable
                ]);
            }

            // Add Workers Sheet
            var ws1 = XLSX.utils.aoa_to_sheet(workersSheetData);
            XLSX.utils.book_append_sheet(wb, ws1, 'Workers');

            // Sub Contractors Data
            var subContractorsSheetData = [
                ['Contractor Name', 'Type of Work', 'Site', 'Total Cost', 'IOU', 'Net Payable']
            ];

            var scRows = reportArea.querySelectorAll('#subContractorsReportTable tr');
            for (var i = 1; i < scRows.length; i++) { // Start after header row
                var cells = scRows[i].querySelectorAll('td');
                // Skip total row
                if (cells[0].innerText.trim() === 'Total') {
                    continue;
                }
                subContractorsSheetData.push([
                    cells[0].innerText, // Contractor Name
                    cells[1].innerText, // Type of Work
                    cells[2].innerText, // Site
                    cells[3].innerText.replace('R', ''), // Total Cost
                    cells[4].innerText.replace('R', ''), // IOU
                    cells[5].innerText.replace('R', '')  // Net Payable
                ]);
            }

            // Add Sub Contractors Sheet
            var ws2 = XLSX.utils.aoa_to_sheet(subContractorsSheetData);
            XLSX.utils.book_append_sheet(wb, ws2, 'Sub Contractors');

            // Export to Excel
            XLSX.writeFile(wb, 'Report.xlsx');
        }

        // Helper Functions for Weekly Report
        function getStartDateOfWeek(year, week) {
            var simple = new Date(year, 0, 1 + (week - 1) * 7);
            var dow = simple.getDay();
            var ISOweekStart = simple;
            if (dow <= 4)
                ISOweekStart.setDate(simple.getDate() - simple.getDay() + 1);
            else
                ISOweekStart.setDate(simple.getDate() + 8 - simple.getDay());
            return ISOweekStart;
        }

        function getDatesOfWeek(startDate) {
            var dates = [];
            for (var i = 0; i < 7; i++) {
                var date = new Date(startDate);
                date.setDate(startDate.getDate() + i);
                dates.push(date);
            }
            return dates;
        }
    </script>
</body>
</html>
